import{_ as e,f as a,G as t,q as s,H as l,u as o,R as n,Q as i,h as u,j as r,k as m,c as d,w as c,i as f,L as p,o as h,a as y,m as g,d as T,x as v,y as x,F as b,n as D,z as _,p as k,T as V,v as C,N as R,O as w}from"./index-h3lAx3Le.js";import{a as S,_ as U,b as I}from"./uni-forms.CfExgS4G.js";import{_ as j}from"./uni-datetime-picker.Ds9IffYk.js";import{U as H}from"./UserInfo.DLZ9WXF6.js";import{a as $}from"./auth.CK2ut5yY.js";const F=e({components:{UserInfo:H},data:()=>({user:$()||{},formData:{timeType:"course",dateRange:[],date:(new Date).toISOString().split("T")[0],courseTime:[],reasonType:"",reason:""},timeTypes:[{value:"dateRange",text:"日期范围"},{value:"course",text:"具体日期和课程时间段"}],courseTimes:[{value:"1",text:"第1节课"},{value:"2",text:"第2节课"},{value:"3",text:"第3节课"},{value:"4",text:"第4节课"},{value:"evening",text:"晚自习"}],reasonTypes:[{value:"走读",text:"走读"},{value:"店铺值班",text:"店铺值班"},{value:"图书馆",text:"图书馆"},{value:"事假",text:"事假"},{value:"病假",text:"病假"},{value:"部门值班",text:"部门值班"},{value:"实训室",text:"实训室"},{value:"晚到",text:"晚到"},{value:"专升本",text:"专升本"},{value:"其他",text:"其他"}],isSubmitting:!1}),methods:{handleCourseTimeChange(e){this.formData.courseTime=e.detail.value},handleReasonTypeChange(e){this.formData.reason="其他"!==e?e:""},goToHistory(){a({url:"/pages/leave/history"})},async submit(){if(!this.isSubmitting){this.isSubmitting=!0,t({title:"提交中...",mask:!0});try{const e=$();let t=this.formData.courseTime;0===t.length&&(t=["1","2","3","4","evening"]);const u="dateRange"===this.formData.timeType?{type:"dateRange",value:this.formData.dateRange}:{type:"course",date:this.formData.date,courseTime:t},r="其他"===this.formData.reasonType?this.formData.reason:this.formData.reasonType,m=await s.callFunction({name:"leave",data:{action:"create",time:u,reason:r,reasonType:this.formData.reasonType,userId:e._id,userName:e.name,classId:e.classId}});if(l(),200===m.result.code){o({title:"创建成功",icon:"success"});const t=`学生${e.name}发出请假信息了，请您查看，地址是：${window.location.origin}/h5/?leave_agree=${m.result.data.id}`,s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);n(s?{title:"请假申请已提交",content:"请手动复制以下链接发送给辅导员进行审批：\n"+t,confirmText:"我已复制",cancelText:"跳转历史",success:e=>{a({url:"/pages/leave/history"})}}:{title:"请假申请已提交",content:"请将以下链接发送给辅导员进行审批：\n"+t,confirmText:"复制链接",cancelText:"直接跳转",success:e=>{e.confirm?i({data:t,success:()=>{o({title:"链接已复制",icon:"success"}),setTimeout((()=>{a({url:"/pages/leave/history"})}),1e3)},fail:e=>{console.error("复制失败:",e),o({title:"复制失败，请手动复制",icon:"none"}),setTimeout((()=>{a({url:"/pages/leave/history"})}),1e3)}}):a({url:"/pages/leave/history"})}}),setTimeout((()=>{this.isSubmitting&&a({url:"/pages/leave/history"})}),5e3)}else o({title:m.result.msg||"提交失败",icon:"none"})}catch(e){console.error("提交请假申请失败:",e),l(),o({title:"提交失败",icon:"none"})}finally{this.isSubmitting=!1}}}}},[["render",function(e,a,t,s,l,o){const n=k,i=f,H=u("UserInfo"),$=r(m("uni-data-select"),p),F=r(m("uni-forms-item"),S),N=r(m("uni-datetime-picker"),j),O=R,q=w,z=V,A=r(m("uni-easyinput"),U),G=C,L=r(m("uni-forms"),I);return h(),d(i,{class:"container"},{default:c((()=>[y(i,{class:"navbar"},{default:c((()=>[y(i,{class:"left"},{default:c((()=>[y(n,{class:"title"},{default:c((()=>[g("请假申请")])),_:1})])),_:1}),y(H,{user:l.user},null,8,["user"])])),_:1}),y(L,{ref:"form",model:l.formData},{default:c((()=>[y(F,{label:"请假时间类型",name:"timeType","label-width":"120px"},{default:c((()=>[y($,{modelValue:l.formData.timeType,"onUpdate:modelValue":a[0]||(a[0]=e=>l.formData.timeType=e),localdata:l.timeTypes},null,8,["modelValue","localdata"])])),_:1}),"dateRange"===l.formData.timeType?(h(),d(F,{key:0,label:"日期范围",name:"dateRange","label-width":"120px"},{default:c((()=>[y(N,{type:"daterange",modelValue:l.formData.dateRange,"onUpdate:modelValue":a[1]||(a[1]=e=>l.formData.dateRange=e)},null,8,["modelValue"])])),_:1})):T("",!0),"course"===l.formData.timeType?(h(),d(F,{key:1,label:"具体日期",name:"date","label-width":"120px"},{default:c((()=>[y(N,{type:"date",modelValue:l.formData.date,"onUpdate:modelValue":a[2]||(a[2]=e=>l.formData.date=e)},null,8,["modelValue"])])),_:1})):T("",!0),"course"===l.formData.timeType?(h(),d(F,{key:2,label:"课程时间段（不选为全天）",name:"courseTime","label-width":"120px"},{default:c((()=>[y(z,{onChange:o.handleCourseTimeChange},{default:c((()=>[(h(!0),v(b,null,x(l.courseTimes,(e=>(h(),d(q,{key:e.value,class:"checkbox-item"},{default:c((()=>[y(O,{value:e.value,checked:l.formData.courseTime.includes(e.value)},null,8,["value","checked"]),y(n,null,{default:c((()=>[g(_(e.text),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["onChange"])])),_:1})):T("",!0),y(F,{label:"请假原因类型",name:"reasonType","label-width":"120px"},{default:c((()=>[y($,{modelValue:l.formData.reasonType,"onUpdate:modelValue":a[3]||(a[3]=e=>l.formData.reasonType=e),localdata:l.reasonTypes,onChange:o.handleReasonTypeChange},null,8,["modelValue","localdata","onChange"])])),_:1}),"其他"===l.formData.reasonType?(h(),d(F,{key:3,label:"请假具体原因",name:"reason","label-width":"120px"},{default:c((()=>[y(A,{modelValue:l.formData.reason,"onUpdate:modelValue":a[4]||(a[4]=e=>l.formData.reason=e),placeholder:"请输入具体请假原因"},null,8,["modelValue"])])),_:1})):T("",!0),y(G,{onClick:o.submit,disabled:l.isSubmitting,class:D(["submit-btn",{loading:l.isSubmitting}])},{default:c((()=>[g(_(l.isSubmitting?"提交中...":"提交"),1)])),_:1},8,["onClick","disabled","class"]),l.isSubmitting?(h(),d(i,{key:4,class:"backup-link"},{default:c((()=>[y(n,{onClick:o.goToHistory},{default:c((()=>[g("如果长时间未跳转，请点击这里查看请假历史")])),_:1},8,["onClick"])])),_:1})):T("",!0)])),_:1},8,["model"])])),_:1})}],["__scopeId","data-v-d0d08363"]]);export{F as default};
