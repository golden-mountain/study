import{_ as t,u as s,q as e,af as n,Q as a,c as i,w as d,i as l,o,a as c,m as u,z as r,d as h,x as F,y as m,F as p,p as g,a6 as f,v as k,n as I,b as x}from"./index-h3lAx3Le.js";import{a as y}from"./auth.CK2ut5yY.js";const C=t({data:()=>({user:null,classInfo:null,students:[],pickCount:1,pickedIndexes:[],pickedStudents:[],isAnimating:!1,animatingIndexes:[],colorList:["#FF9999","#99FF99","#9999FF","#FFFF99","#FF99FF","#99FFFF","#FFB399","#99FFB3","#B399FF","#FFE599","#FF99E5","#99FFE5","#E599FF","#E5FF99","#99E5FF","#FFB3B3","#B3FFB3","#B3B3FF","#FFFFB3","#FFB3FF","#B3FFFF","#FFCC99","#99FFCC","#CC99FF","#FFFF99"],defaultPhoto:"/static/avatar/default.png",photoErrors:{}}),computed:{canPick(){return this.students.length>0&&this.pickCount>0&&this.pickCount<=this.students.length}},async onLoad(t){this.user=y(),t.classId?await this.loadClassInfo(t.classId):this.user&&this.user.classId?await this.loadClassInfo(this.user.classId):s({title:"未找到班级信息",icon:"none"})},methods:{async loadClassInfo(t){try{const s=await e.callFunction({name:"class",data:{action:"get",id:t}});if(200===s.result.code){this.classInfo=s.result.data;const n=await e.callFunction({name:"class",data:{action:"listMembers",classId:t}});200===n.result.code&&(this.students=n.result.data.filter((t=>!t.role||Array.isArray(t.role)&&!t.role.includes("instructor"))))}}catch(n){console.error("加载班级信息失败:",n),s({title:"加载班级信息失败",icon:"none"})}},getStudentColor(t){return this.colorList[t%this.colorList.length]},getStudentPhoto:t=>`/h5/static/student/${t.name}.jpg`,handleImageError(t){this.photoErrors[t.studentId]||(this.photoErrors[t.studentId]=!0,this.$forceUpdate())},formatStudentId:t=>t?t.length>4?t.slice(-4):t:"",startRandomPick(){if(!this.canPick||this.isAnimating)return;this.isAnimating=!0,this.animatingIndexes=[],this.pickedIndexes=[],this.pickedStudents=[],this.students.forEach((t=>{this.$set(t,"flyOut",!1)})),setTimeout((()=>{this.students.forEach((t=>{const s=new Image;s.onerror=()=>this.handleImageError(t),s.src=this.getStudentPhoto(t)}))}),0);const t=Math.floor(2e3/300);let s=0;this.playSound("/static/sound/shuffle.mp3");const e=this.getRandomIndexes(this.pickCount),n=setInterval((()=>{if(s++,s<t){const t=this.getRandomIndexesExcluding(Math.min(this.pickCount,this.students.length),e);this.animatingIndexes=t}else clearInterval(n),this.finishRandomPick(e)}),300)},finishRandomPick(t){this.pickedIndexes=t||this.getRandomIndexes(this.pickCount),this.pickedStudents=this.pickedIndexes.map((t=>this.students[t])),this.animatingIndexes=[],this.isAnimating=!1,this.playSound("/static/sound/card-flip.mp3")},playSound(t){const s=n();s.autoplay=!0,s.src=t},getRandomIndexes(t){if(t>=this.students.length)return Array.from({length:this.students.length},((t,s)=>s));const s=[];let e=this.students.map(((t,s)=>({student:t,index:s}))).map((t=>t.index));for(;s.length<t&&e.length>0;){const t=Math.floor(Math.random()*e.length),n=e.splice(t,1)[0];s.push(n)}return s},getRandomIndexesExcluding(t,s){if(t>=this.students.length-s.length)return Array.from({length:this.students.length},((t,s)=>s)).filter((t=>!s.includes(t)));const e=[];for(;e.length<t;){const t=Math.floor(Math.random()*this.students.length);e.includes(t)||s.includes(t)||e.push(t)}return e},copyStudentList(){let t=this.pickedStudents.map((t=>t.name)).join("、");a({data:t,success:()=>{s({title:"已复制名单",icon:"success"})},fail:t=>{console.error("复制失败:",t),s({title:"复制失败",icon:"none"})}})}}},[["render",function(t,s,e,n,a,y){const C=g,S=f,_=l,E=k;return o(),i(_,{class:"container"},{default:d((()=>[c(_,{class:"header"},{default:d((()=>[c(C,{class:"title"},{default:d((()=>[u("随机抓阉")])),_:1}),c(_,{class:"controls"},{default:d((()=>[c(_,{class:"input-group"},{default:d((()=>[c(C,null,{default:d((()=>[u("抽取人数:")])),_:1}),c(S,{type:"number",modelValue:a.pickCount,"onUpdate:modelValue":s[0]||(s[0]=t=>a.pickCount=t),class:"pick-input",placeholder:"输入抽取人数",min:"1",max:a.students.length},null,8,["modelValue","max"])])),_:1}),c(E,{class:"pick-button",type:"primary",onClick:y.startRandomPick,disabled:a.isAnimating||!y.canPick},{default:d((()=>[u(r(a.isAnimating?"选择中...":"开始抓阉"),1)])),_:1},8,["onClick","disabled"]),a.pickedStudents.length>0?(o(),i(E,{key:0,class:"copy-button",onClick:y.copyStudentList},{default:d((()=>[u(" 复制名单 ")])),_:1},8,["onClick"])):h("",!0)])),_:1})])),_:1}),c(_,{class:"student-grid"},{default:d((()=>[(o(!0),F(p,null,m(a.students,((t,s)=>(o(),i(_,{key:t.studentId,class:I(["student-card",{"student-highlighted":a.pickedIndexes.includes(s),"student-animating":a.isAnimating&&a.animatingIndexes.includes(s),flipped:a.pickedIndexes.includes(s)||a.isAnimating&&a.animatingIndexes.includes(s)}]),style:x({backgroundColor:y.getStudentColor(s)})},{default:d((()=>[c(_,{class:"card-inner"},{default:d((()=>[c(_,{class:"card-back"},{default:d((()=>[c(_,{class:"card-back-pattern"})])),_:1}),c(_,{class:"card-front"},{default:d((()=>[c(_,{class:"student-photo",style:x({backgroundImage:`url(${y.getStudentPhoto(t)})`,backgroundPosition:"center center",backgroundSize:"cover"})},null,8,["style"]),c(C,{class:"student-name"},{default:d((()=>[u(r(t.name),1)])),_:2},1024),c(C,{class:"student-id"},{default:d((()=>[u(r(y.formatStudentId(t.studentId)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["class","style"])))),128))])),_:1})])),_:1})}],["__scopeId","data-v-d0f9c18b"]]);export{C as default};
