import{_ as e,o as t,c as a,w as s,a as n,n as l,m as i,z as r,p as c,i as d,q as o,A as u,a0 as h,s as f,u as m,G as y,H as g,Q as p,R as k,a1 as C,a2 as S,a3 as w,j as D,l as _,k as b,d as v,x as I,y as A,F as T,W as L,v as $,P as W,N as O,a4 as M,f as N,g as x,h as F,a5 as R}from"./index-h3lAx3Le.js";import{_ as E}from"./uni-datetime-picker.Ds9IffYk.js";import{a as H}from"./auth.CK2ut5yY.js";function U(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function j(e,t){const a=new Date,s=[];if(t){const a=Math.floor(3*Math.random())+1;for(let n=0;n<a;n++)s.push(K(e,t,n))}else for(let n=0;n<7;n++){const t=new Date(a);t.setDate(t.getDate()-n);const l=U(t),i=Math.floor(3*Math.random())+1;for(let a=0;a<i;a++)s.push(K(e,l,a))}return s.map((e=>({...e,isMock:!0})))}function K(e,t,a){const s=[{start:"08:30",end:"10:00"},{start:"10:30",end:"12:00"},{start:"14:00",end:"15:20"},{start:"15:30",end:"16:50"},{start:"19:00",end:"20:40"}],n=s[a%s.length],l=new Date(t),[i,r]=n.start.split(":").map(Number);l.setHours(i),l.setMinutes(r+Math.floor(15*Math.random()));const c=B(l);return{_id:`mock_${t}_${a}`,userId:e,time:l.toISOString(),date:t,day:c,startTime:n.start,endTime:n.end,courseName:P(),status:"attended",location:"çº¬åº¦: 30.123456, ç»åº¦: 120.123456"}}function P(){const e=["ç—…ç†å­¦ä¸ç—…ç†ç”Ÿç†å­¦","ä¸­è¯å­¦","å¤§å­¦è‹±è¯­2","ä¸­åŒ»è¯Šæ–­å­¦","è¯ç†å­¦","è¯Šæ–­å­¦","å›½å®¶å®‰å…¨æ•™è‚²","æ¯›æ³½ä¸œæ€æƒ³å’Œä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“ç³»æ¦‚è®º","ä½“è‚²ä¸å¥åº·2","ä¿¡æ¯æŠ€æœ¯2","çº¢è‰²æ–‡åŒ–","å½¢åŠ¿ä¸æ”¿ç­–2","æ™šè‡ªä¹ "];return e[Math.floor(Math.random()*e.length)]}async function Y(e,t,a,s,n){try{const l={action:"getLeaveRecords"};e?l.userId=e:n&&(l.classId=n),a&&s?(l.startDate=a,l.endDate=s):t&&(l.date=t);const i=await o.callFunction({name:"attendance",data:l});return i&&i.result&&i.result.data?i.result.data:[]}catch(l){return[]}}function V(e,t,a){const s=[{_id:"1",name:"å¼ ä¸‰",phone:"13800000001",attendanceStatus:"not-checked"},{_id:"2",name:"æå››",phone:"13800000002",attendanceStatus:"not-checked"},{_id:"3",name:"ç‹äº”",phone:"13800000003",attendanceStatus:"not-checked"},{_id:"4",name:"èµµå…­",phone:"13800000004",attendanceStatus:"not-checked"},{_id:"5",name:"é’±ä¸ƒ",phone:"13800000005",attendanceStatus:"not-checked"}],n=new Date;return s.map(((s,l)=>{const i=["attended","not-checked","leave"],r=i[Math.floor(Math.random()*i.length)];let c=null;if("attended"===r){const e=new Date(n);e.setHours(t?parseInt(t.split(":")[0]):8),e.setMinutes(t?parseInt(t.split(":")[1])+Math.floor(30*Math.random()):30),c=e.toISOString()}return{_id:`mock_${l}`,userId:s._id,name:s.name,status:r,time:c,date:e,startTime:t,endTime:a,reason:"leave"===r?"èº«ä½“ä¸é€‚":null,isMock:!0}}))}async function z(e){try{console.log("æäº¤æ‰“å¡å‚æ•°:",e);const t=H(),a={...e,userId:e.userId||t._id,name:e.name||t.name,classId:e.classId||t.classId,time:e.time||(new Date).toISOString()};console.log("å®Œæ•´æ‰“å¡å‚æ•°:",a);const s=await o.callFunction({name:"attendance",data:{action:"submit",params:a}});return console.log("æ‰“å¡è¿”å›ç»“æœ:",s.result),s.result&&400===s.result.code&&s.result.msg&&s.result.msg.includes("é‡å¤æ‰“å¡")?{...s.result,isDuplicate:!0}:s.result}catch(t){throw console.error("æ‰“å¡è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:",t),t}}function q(e){const t={total:e.length,attended:0,notChecked:0,leave:0};return e.forEach((e=>{switch(e.attendanceStatus){case"attended":t.attended++;break;case"not-checked":t.notChecked++;break;case"leave":t.leave++}})),t}function B(e){return 0===e.getDay()?"æ˜ŸæœŸå¤©":["æ˜ŸæœŸå¤©","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”","æ˜ŸæœŸå…­"][e.getDay()]}function J(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function G(e,t=!0){try{const a=(f("offlineCheckIns")||[]).map((a=>a.timestamp===e?{...a,synced:t}:a));return u("offlineCheckIns",a),!0}catch(a){return!1}}function Q(e,t,a,s){if(!Array.isArray(t)||0===t.length)return null;const n=H()._id||s,l=function(e){if(!e||!e.day)return null;if(e.date)return e.date;if(e.weekDate){const t={"æ˜ŸæœŸå¤©":0,"æ˜ŸæœŸä¸€":1,"æ˜ŸæœŸäºŒ":2,"æ˜ŸæœŸä¸‰":3,"æ˜ŸæœŸå››":4,"æ˜ŸæœŸäº”":5,"æ˜ŸæœŸå…­":6}[e.day];if(void 0!==t){const a=new Date(e.weekDate),s=new Date(a);return s.setDate(a.getDate()+t),s.toISOString().split("T")[0]}}return null}(e);if(!l)return null;const i=new Date(l);for(const r of t)if(r.userId===n)if(r.time&&"course"===r.time.type){const t=r.time.date;if(!t||t!==l)continue;const s=X(e,a);if(null===s)continue;if(Array.isArray(r.time.courseTime)&&r.time.courseTime.includes(s.toString()))return r}else if(r.time&&"dateRange"===r.time.type&&Array.isArray(r.time.value)&&2===r.time.value.length){const e=new Date(r.time.value[0]),t=new Date(r.time.value[1]);if(i>=e&&i<=t)return r}else{if(r.courseTime&&Array.isArray(r.courseTime)){if(r.courseTime.some((t=>{if(!t)return!1;const s=a[t];if(!s)return!1;const[n,l]=s.split("-");return n===e.start&&l===e.end})))return r}if(r.startTime&&r.endTime){const[t,a]=e.start.split(":").map(Number),[s,n]=e.end.split(":").map(Number),[l,i]=r.startTime.split(":").map(Number),[c,d]=r.endTime.split(":").map(Number),o=60*s+n,u=60*l+i;if(60*t+a<=60*c+d&&o>=u)return r}}return null}function X(e,t){for(const[l,i]of Object.entries(t)){const[t,a]=i.split("-");if(t===e.start&&a===e.end)return l}const a=Z(e.start),s=Z(e.end),n=Object.entries(t).sort(((e,t)=>{const[a]=e[1].split("-"),[s]=t[1].split("-");return Z(a)-Z(s)}));for(const[l,i]of n){const[e,t]=i.split("-"),n=Z(e),r=Z(t);if(n<=s&&r>=a)return l}return null}function Z(e){const[t,a]=e.split(":").map(Number);return 60*t+a}function ee(e,t,a,s,n){if(!e||!Array.isArray(e)||0===e.length)return[];if(t&&Array.isArray(t)||(t=[]),a&&Array.isArray(a)||(a=[]),!s||"object"!=typeof s)return e;if(!n)return e;const l=H()._id||n,i=new Date,r=B(i),c=te(r),d=e.map(((e,n)=>{if(!e||"object"!=typeof e)return e;const d=Q(e,a,s,l);if(d)return{...e,status:"leave",leaveId:d._id,leaveReason:d.reason||"æ— ç†ç”±",leaveTime:d.createTime,leaveStatus:d.status||"pending"};const o=function(e,t,a){if(!Array.isArray(t)||0===t.length)return null;const s=e.start,n=e.end,l=e.date,i=e.weekDate;e.day;let r=null;i&&(r=new Date(i),r.setDate(r.getDate()+6));for(const c of t){let e=null;if(e=new Date(c.time).toISOString().split("T")[0],e===l){let e=null;if(c.time){e=new Date(c.time).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1})}if(!e)continue;if(ae(e,s,n))return c}}return null}(e,t);if(o){const t=function(e,t){if(!e||!t||!t.time)return!1;const a=new Date(t.time),s=a.getHours(),n=a.getMinutes(),[l,i]=e.start.split(":").map(Number);return 60*s+n>60*l+i+15}(e,o);return{...e,status:"attended",attendanceId:o._id,attendanceTime:o.time,isLate:t,isPast:e.isPast||!1,isFuture:!1}}const u=te(e.day),h=function(e,t,a,s,n){if(!(e&&e.start&&e.end&&e.day))return!1;if(s<a)return"æ˜ŸæœŸå¤©"!==e.day||"æ˜ŸæœŸå¤©"===t;if(e.day===t){const[t,a]=e.end.split(":").map(Number),s=n.getHours(),l=n.getMinutes();if(s>t||s===t&&l>a)return!0}return!1}(e,r,c,u,i);return h?{...e,status:"not-checked",isPast:!0,isFuture:!1}:e.isFuture||function(e,t){if(!(e&&e.start&&e.end&&e.day))return!1;const a=new Date,s=new Date(a.getFullYear(),a.getMonth(),a.getDate()),n=B(a);if(e.day===n){const[t,n]=e.start.split(":").map(Number),l=new Date(s);return l.setHours(t,n,0),a<l}const l=te(n),i=te(e.day);return i>l||i<l&&"æ˜ŸæœŸå¤©"===e.day}(e)?{...e,status:"not-checked",isFuture:!0,isPast:!1}:e}));return d}function te(e){return{"æ˜ŸæœŸå¤©":0,"æ˜ŸæœŸä¸€":1,"æ˜ŸæœŸäºŒ":2,"æ˜ŸæœŸä¸‰":3,"æ˜ŸæœŸå››":4,"æ˜ŸæœŸäº”":5,"æ˜ŸæœŸå…­":6}[e]||0}function ae(e,t,a){if(!e||!t||!a)return!1;try{const[s,n]=e.split(":").map(Number),[l,i]=t.split(":").map(Number),[r,c]=a.split(":").map(Number),d=60*s+n,o=60*r+c+30;return d>=60*l+i-30&&d<=o}catch(s){return!1}}async function se(e){try{const a=H();try{const t=await o.callFunction({name:"class_table",data:{action:"get",classId:e||a.classId}});if(t.result&&t.result.data&&t.result.data.startDate){const e=t.result.data.startDate;return u("startDate",e),e}}catch(t){}const s={action:"getClassAttendance",type:"start_date"};if("student"===a.role)s.userId=a._id,a.classId&&(s.classId=a.classId);else if(e)s.classId=e;else{if(!a.classId)return null;s.classId=a.classId}const n=await o.callFunction({name:"attendance",data:s});if(n.result&&n.result.data){const e=Array.isArray(n.result.data)?n.result.data[0]:n.result.data;if(e&&e.startDate)return u("startDate",e.startDate),e.startDate}const l="2025/2/16";return u("startDate",l),l}catch(a){const e="2025/2/16";return u("startDate",e),e}}const ne=e({components:{AttendanceStats:e({name:"AttendanceStats",props:{stats:{type:Object,required:!0},currentFilter:{type:String,default:"all"}},methods:{handleFilterChange(e){this.$emit("filter-change",e)}}},[["render",function(e,o,u,h,f,m){const y=c,g=d;return t(),a(g,{class:"stats-container"},{default:s((()=>[n(g,{class:"badge-container"},{default:s((()=>[n(g,{class:l(["filter-badge",{active:"all"===u.currentFilter}]),onClick:o[0]||(o[0]=e=>m.handleFilterChange("all"))},{default:s((()=>[n(y,{class:"filter-label"},{default:s((()=>[i("æ€»äººæ•°")])),_:1}),n(y,{class:"filter-value"},{default:s((()=>[i(r(u.stats.total),1)])),_:1})])),_:1},8,["class"]),n(g,{class:l(["filter-badge",{active:"attended"===u.currentFilter}]),onClick:o[1]||(o[1]=e=>m.handleFilterChange("attended"))},{default:s((()=>[n(y,{class:"filter-label"},{default:s((()=>[i("å·²æ‰“å¡")])),_:1}),n(y,{class:"filter-value"},{default:s((()=>[i(r(u.stats.attended),1)])),_:1})])),_:1},8,["class"]),n(g,{class:l(["filter-badge",{active:"not-checked"===u.currentFilter}]),onClick:o[2]||(o[2]=e=>m.handleFilterChange("not-checked"))},{default:s((()=>[n(y,{class:"filter-label"},{default:s((()=>[i("æœªæ‰“å¡")])),_:1}),n(y,{class:"filter-value"},{default:s((()=>[i(r(u.stats.notChecked),1)])),_:1})])),_:1},8,["class"]),n(g,{class:l(["filter-badge",{active:"leave"===u.currentFilter}]),onClick:o[3]||(o[3]=e=>m.handleFilterChange("leave"))},{default:s((()=>[n(y,{class:"filter-label"},{default:s((()=>[i("è¯·å‡")])),_:1}),n(y,{class:"filter-value"},{default:s((()=>[i(r(u.stats.leave),1)])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})}],["__scopeId","data-v-3f050990"]]),StudentAttendance:e({name:"StudentAttendance",props:{myAttendanceList:{type:Array,required:!0},isSubmitting:{type:Boolean,default:!1},weekSchedule:{type:Array,default:()=>[]},currentWeekOffset:{type:Number,default:0},currentWeekNumber:{type:Number,default:1}},data(){return{collapsedDays:{},collapsedCourses:{},maxWeekOffset:4,minWeekOffset:-4,localWeekNumber:this.currentWeekNumber,checkInTimers:{},currentTime:new Date,offlineCheckIns:[],isOffline:!1,timeUpdateInterval:null,dayOrder:["æ˜ŸæœŸå¤©","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”","æ˜ŸæœŸå…­"],showLeaveForm:!1,currentCourse:null,leaveReason:"",isSubmittingLeave:!1,leaveSubmitted:{}}},computed:{currentWeekText(){const e=this.localWeekNumber||1;return 0===this.currentWeekOffset?`æœ¬å‘¨ï¼ˆç¬¬${e}å‘¨ï¼‰`:(this.currentWeekOffset,`ç¬¬${e}å‘¨`)},filteredCourses(){if(!Array.isArray(this.myAttendanceList)||0===this.myAttendanceList.length)return[];const e={};this.dayOrder.forEach((t=>{e[t]={day:t,courses:[]}})),this.myAttendanceList.forEach((t=>{if(t&&t.day&&e[t.day])e[t.day].courses.push(t);else if(t&&e["æ˜ŸæœŸä¸€"]){const a={...t,day:"æ˜ŸæœŸä¸€"};e["æ˜ŸæœŸä¸€"].courses.push(a)}})),Object.values(e).forEach((e=>{e.courses.sort(((e,t)=>{const a=e.start?e.start.split(":").map(Number):[0,0],s=t.start?t.start.split(":").map(Number):[0,0];return 60*a[0]+a[1]-(60*s[0]+s[1])}))}));return this.dayOrder.filter((t=>e[t]&&e[t].courses.length>0)).map((t=>e[t]))},hasAnyCourses(){return Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0},hasOfflineCheckIns(){return this.offlineCheckIns.length>0},pendingSyncCount(){return this.offlineCheckIns.filter((e=>!e.synced)).length},hasCheckInCourse(){if(0!==this.currentWeekOffset)return!1;const e=B(new Date);return!!this.myAttendanceList.find((t=>t.day===e&&"not-checked"===t.status&&this.isInCheckInTimeWindow(t)))},checkInCourseName(){if(!this.hasCheckInCourse)return"";const e=B(new Date),t=this.myAttendanceList.find((t=>t.day===e&&"not-checked"===t.status&&this.isInCheckInTimeWindow(t)));return t?t.label:""},checkInTimeRemaining(){if(!this.hasCheckInCourse)return"";const e=B(new Date),t=this.myAttendanceList.find((t=>t.day===e&&"not-checked"===t.status&&this.isInCheckInTimeWindow(t)));if(!t)return"";return`å‰©ä½™æ‰“å¡æ—¶é—´ï¼š${this.getRemainingCheckInTime(t)}åˆ†é’Ÿ`}},watch:{myAttendanceList:{handler(e){e&&e.length;const t=B(new Date);this.$nextTick((()=>{this.filteredCourses&&Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0&&this.filteredCourses.forEach((e=>{this.$set(this.collapsedDays,e.day,e.day!==t)})),this.$forceUpdate()}))},deep:!0,immediate:!0},currentWeekOffset:{handler(e){this.collapsedDays={},this.collapsedCourses={},this.$nextTick((()=>{const t=B(new Date);this.filteredCourses&&Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0&&(this.filteredCourses.forEach((a=>{const s=0!==e||a.day!==t;this.$set(this.collapsedDays,a.day,s)})),this.$forceUpdate())}))},immediate:!0},filteredCourses:{handler(e){const t=B(new Date);e.forEach((e=>{void 0===this.collapsedDays[e.day]&&this.$set(this.collapsedDays,e.day,e.day!==t)}))},deep:!0,immediate:!0},currentWeekNumber:{handler(e){this.localWeekNumber=e},immediate:!0}},methods:{mapStatusValue(e){switch(e){case"attended":case"checked":case"check-in":case"checkin":return"attended";case"leave":case"leaved":case"on-leave":return"leave";case"not-checked":case"absent":case"unchecked":return"not-checked";default:return e||"not-checked"}},generatePastTime(e){const[t,a]=e.start.split(":").map(Number),s=new Date;return s.setDate(s.getDate()+7*this.currentWeekOffset),s.setHours(t,a+Math.floor(30*Math.random())),s.toISOString()},navigateWeek(e){const t=this.currentWeekOffset+e;t>this.maxWeekOffset||t<this.minWeekOffset?m({title:"å·²è¾¾åˆ°å¯æŸ¥çœ‹èŒƒå›´çš„è¾¹ç•Œ",icon:"none"}):(this.$emit("week-change",t),this.collapsedDays={},this.collapsedCourses={},this.$nextTick((()=>{this.initCollapseState()})))},async getCurrentWeekNumber(){try{if(this.currentWeekNumber)return void(this.localWeekNumber=this.currentWeekNumber);const e=function(e){try{if(!e){e=f("startDate")||"2025/2/16"}let t;if("string"==typeof e)if(e.includes("/")){const a=e.split("/");t=new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]))}else e.includes("-"),t=new Date(e);else t=e instanceof Date?e:new Date("2025/2/16");isNaN(t.getTime())&&(t=new Date("2025/2/16"));const a=new Date,s=Math.abs(a-t),n=Math.ceil(s/864e5);return Math.floor(n/7)+1}catch(t){return 1}}(await se());this.localWeekNumber=e||1,this.$emit("update:currentWeekNumber",this.localWeekNumber),this.$forceUpdate()}catch(e){this.localWeekNumber=1}},initCollapseState(){const e=B(new Date);this.filteredCourses&&Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0&&this.filteredCourses.forEach((t=>{this.$set(this.collapsedDays,t.day,t.day!==e),t.courses&&Array.isArray(t.courses)&&t.courses.forEach((e=>{this.isExpired(e)&&this.$set(this.collapsedCourses,this.getCourseKey(e),!0)}))}))},getCourseKey:e=>`${e._id||e.id||""}_${e.day||""}_${e.date||""}_${e.start||""}_${e.end||""}`,toggleDayCollapse(e){this.$set(this.collapsedDays,e,!this.collapsedDays[e])},toggleCourseCollapse(e){const t=this.getCourseKey(e);this.$set(this.collapsedCourses,t,!this.collapsedCourses[t])},isExpired(e){if(!(e&&e.start&&e.end&&e.day))return!1;const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=B(t);if(this.getDayIndex(e.day)<this.getDayIndex(s))return"æ˜ŸæœŸå¤©"!==e.day||"æ˜ŸæœŸå¤©"===s;if(e.day===s){const[s,n]=e.end.split(":").map(Number),l=new Date(a);return l.setHours(s,n,0,0),t>l}return!1},getDayIndex:e=>({"æ˜ŸæœŸå¤©":0,"æ˜ŸæœŸä¸€":1,"æ˜ŸæœŸäºŒ":2,"æ˜ŸæœŸä¸‰":3,"æ˜ŸæœŸå››":4,"æ˜ŸæœŸäº”":5,"æ˜ŸæœŸå…­":6}[e]||0),isInCheckInTimeWindow(e){if(!(e&&e.start&&e.end&&e.day))return!1;const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=B(t);if(e.day!==s)return!1;const[n,l]=e.start.split(":").map(Number),[i,r]=e.end.split(":").map(Number),c=new Date(a);c.setHours(n,l,0,0);const d=new Date(a);d.setHours(i,r,0,0);const o=new Date(c);o.setHours(o.getHours()-1);const u=new Date(d);return u.setHours(u.getHours()+1),t>=o&&t<=u},isUpcomingCheckIn(e){if(!(e&&e.start&&e.end&&e.day))return!1;const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=B(t);if(e.day!==s)return!1;const[n,l]=e.start.split(":").map(Number),i=new Date(a);return i.setHours(n,l,0,0),function(e,t){const a=new Date(t);return a.setMinutes(a.getMinutes()-30),e>=a&&e<t}(t,i)},isCollapsible:e=>e.day!==B(new Date),getStatusClass(e){const t=this.mapStatusValue(e.status);return"attended"===t?e.isOffline?"offline":e.isLate?"late":"attended":"leave"===t?"approved"===e.leaveStatus||"pending"===e.leaveStatus?"approved"===e.leaveStatus?"leave-approved":"leave-pending":"not-checked":"not-checked"===t?this.isExpired(e)?"absent":e.isFuture?"future":"not-checked":e.isFuture?"future":t||"not-checked"},getStatusText(e){const t=this.mapStatusValue(e.status);return"attended"===t?e.isOffline?"ç¦»çº¿æ‰“å¡":e.isLate?"è¿Ÿåˆ°":"å·²æ‰“å¡":"leave"===t?"approved"===e.leaveStatus||"pending"===e.leaveStatus?"approved"===e.leaveStatus?"å·²å‡†å‡":"è¯·å‡æœªæ‰¹":"æœªæ‰“å¡":"not-checked"===t?this.isExpired(e)?"æ—·è¯¾":this.isInCheckInTimeWindow(e)?"å¯æ‰“å¡":this.isUpcomingCheckIn(e)?"å³å°†å¼€å§‹":e.isFuture?"å¾…æ‰“å¡":"æœªæ‰“å¡":e.isFuture?"æœªå¼€å§‹":"æœªçŸ¥çŠ¶æ€"},canCheckIn(e){if("attended"===e.status)return!1;if(0!==this.currentWeekOffset||e.isFuture||this.isExpired(e)||"not-checked"!==e.status)return!1;const t=B(new Date);return e.day===t&&this.isInCheckInTimeWindow(e)},canApplyLeave(e){return"attended"!==e.status&&(!(!this.leaveSubmitted[this.getCourseKey(e)]||"cancelled"===e.leaveStatus||"rejected"===e.leaveStatus)||("leave"!==e.status||"approved"!==e.leaveStatus&&"pending"!==e.leaveStatus)&&(!this.isExpired(e)&&0===this.currentWeekOffset))},async handleCheckIn(e){if(this.canCheckIn(e)){y({title:"æ­£åœ¨æ‰“å¡...",mask:!0});try{if(await this.checkNetworkStatus(),this.isOffline)await this.saveOfflineCheckIn(e);else{let a=null;try{a=await this.getCurrentLocation(),console.log("è·å–åˆ°ä½ç½®ä¿¡æ¯:",a)}catch(t){console.error("è·å–ä½ç½®å¤±è´¥:",t),a={latitude:0,longitude:0,address:"ä½ç½®æœªçŸ¥ (è¯·æ£€æŸ¥ä½ç½®æƒé™)"}}const s={courseId:e._id,courseName:e.label||e.name,date:J(this.currentTime),startTime:e.start,endTime:e.end,location:a,userId:H()._id,name:H().name,classId:H().classId,time:(new Date).toISOString(),day:e.day};console.log("æäº¤æ‰“å¡å‚æ•°:",s),e.isCheckedIn=!0,e.status="attended",e.attendanceTime=(new Date).toISOString();const n=new Date,[l,i]=e.start.split(":").map(Number);n.setHours(l,i,0,0),e.isLate=function(e,t){return e>t}(this.currentTime,n);const r=await z(s);if(r&&200===r.code)m({title:e.isLate?"å·²æ‰“å¡(è¿Ÿåˆ°)":"æ‰“å¡æˆåŠŸ",icon:"success"}),this.$emit("data-updated");else{if(!r||!r.isDuplicate)throw e.isCheckedIn=!1,e.status="not-checked",e.attendanceTime=null,e.isLate=!1,console.error("æ‰“å¡å¤±è´¥ï¼Œè¿”å›ç»“æœ:",r),new Error((null==r?void 0:r.msg)||"æ‰“å¡å¤±è´¥");m({title:"æ‚¨å·²ç»æ‰“è¿‡å¡äº†",icon:"none"}),setTimeout((async()=>{try{await this.getCurrentWeekNumber(),await this.checkNetworkStatus(),await this.checkLeaveStatus(),this.updateCoursesStatus(),this.$emit("data-updated")}catch(e){console.error("åˆ·æ–°æ•°æ®å¤±è´¥:",e)}}),1e3)}}}catch(a){console.error("æ‰“å¡è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:",a),a.message&&a.message.includes("é‡å¤æ‰“å¡")?(m({title:"æ‚¨å·²ç»æ‰“è¿‡å¡äº†ï¼Œæ­£åœ¨åˆ·æ–°æ•°æ®...",icon:"none",duration:2e3}),setTimeout((async()=>{try{await this.getCurrentWeekNumber(),await this.checkNetworkStatus(),await this.checkLeaveStatus(),this.updateCoursesStatus(),this.$emit("data-updated"),m({title:"æ•°æ®å·²åˆ·æ–°",icon:"success"})}catch(e){console.error("åˆ·æ–°æ•°æ®å¤±è´¥:",e)}}),1e3)):m({title:a.message||"æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{g()}}else m({title:"å½“å‰ä¸åœ¨æ‰“å¡æ—¶é—´èŒƒå›´å†…",icon:"none"})},handleApplyLeave(e){if("attended"!==e.status)if(this.leaveSubmitted[this.getCourseKey(e)]&&"cancelled"!==e.leaveStatus&&"rejected"!==e.leaveStatus){const t=`å­¦ç”Ÿ${H().name}å‘å‡ºè¯·å‡ä¿¡æ¯äº†ï¼Œè¯·æ‚¨æŸ¥çœ‹ï¼Œåœ°å€æ˜¯ï¼š${window.location.origin}/h5/?leave_agree=${this.leaveSubmitted[this.getCourseKey(e)]}`;p({data:t,success:()=>{m({title:"è¯·å‡é“¾æ¥å·²å¤åˆ¶",icon:"success"})},fail:()=>{m({title:"å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}})}else this.currentCourse=e,this.showLeaveForm=!0;else m({title:"å·²æ‰“å¡è¯¾ç¨‹ä¸èƒ½è¯·å‡",icon:"none"})},cancelLeave(){this.showLeaveForm=!1,this.leaveReason="",this.currentCourse=null},async submitLeave(){if(this.leaveReason){if(!this.isSubmittingLeave){this.isSubmittingLeave=!0;try{const e=H(),t=(e=>{const t=`${e.start}-${e.end}`;return{"08:30-10:00":"1","10:30-12:00":"2","14:00-15:20":"3","15:30-16:50":"4","19:00-20:40":"evening"}[t]||t})(this.currentCourse),a=(await o.callFunction({name:"leave",data:{action:"create",time:{type:"course",date:this.currentCourse.date,courseTime:[t]},reason:this.leaveReason,userId:e._id,userName:e.name,classId:e.classId}})).result;if(200===a.code){this.$set(this.leaveSubmitted,this.getCourseKey(this.currentCourse),a.data.id),this.saveLeaveSubmitted(),this.currentCourse.status="leave",this.currentCourse.leaveStatus="pending",this.currentCourse.leaveId=a.data.id,this.updateCoursesStatus(),this.cancelLeave(),m({title:"è¯·å‡ç”³è¯·å·²æäº¤",icon:"success"});const t=`å­¦ç”Ÿ${e.name}å‘å‡ºè¯·å‡ä¿¡æ¯äº†ï¼Œè¯·æ‚¨æŸ¥çœ‹ï¼Œåœ°å€æ˜¯ï¼š${window.location.origin}/h5/?leave_agree=${a.data.id}`,s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);k(s?{title:"è¯·å‡ç”³è¯·å·²æäº¤",content:"è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™è¾…å¯¼å‘˜è¿›è¡Œå®¡æ‰¹ï¼š\n"+t,confirmText:"æˆ‘å·²å¤åˆ¶",success:()=>{}}:{title:"è¯·å‡ç”³è¯·å·²æäº¤",content:"è¯·å°†ä»¥ä¸‹é“¾æ¥å‘é€ç»™è¾…å¯¼å‘˜è¿›è¡Œå®¡æ‰¹ï¼š\n"+t,confirmText:"å¤åˆ¶é“¾æ¥",cancelText:"å…³é—­",success:e=>{e.confirm&&p({data:t,success:()=>{m({title:"é“¾æ¥å·²å¤åˆ¶",icon:"success"})},fail:e=>{m({title:"å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶",icon:"none"})}})}}),this.$emit("data-updated")}else m({title:a.msg||"è¯·å‡ç”³è¯·å¤±è´¥",icon:"none"}),this.cancelLeave()}catch(e){m({title:"è¯·å‡ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"}),this.cancelLeave()}finally{this.isSubmittingLeave=!1}}}else m({title:"è¯·è¾“å…¥è¯·å‡ç†ç”±",icon:"none"})},formatTime(e){if(!e)return"";let t;if("string"==typeof e){if(e.match(/^\d{1,2}:\d{2}$/))return e;t=new Date(e)}else t=e;return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},updateStatus(e,t){if(e)try{"attended"===t?this.handleCheckIn(e):"leave"===t&&this.handleApplyLeave(e)}catch(a){}},getDayDate(e){const t=new Date,a=B(t),s=this.getDayIndex(a);let n=this.getDayIndex(e)-s;n<0&&(n+=7),n+=7*this.currentWeekOffset;const l=new Date(t);l.setDate(t.getDate()+n);return`${l.getMonth()+1}æœˆ${l.getDate()}æ—¥`},getRemainingCheckInTime(e){if(!this.isInCheckInTimeWindow(e))return null;const t=this.currentTime,[a,s]=e.start.split(":").map(Number),n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),l=new Date(n);l.setHours(a,s,0,0);const i=new Date(l);i.setHours(i.getHours()+1);const r=i-t,c=Math.floor(r/6e4);return c>0?c:0},formatRemainingTime:e=>null===e?"":e<=0?"æ‰“å¡æ—¶é—´å·²ç»“æŸ":`å‰©ä½™ ${e} åˆ†é’Ÿ`,updateCurrentTime(){const e=this.currentTime;this.currentTime=new Date,0===this.currentWeekOffset&&this.checkCourseStatusChanges(e),setTimeout((()=>{this.updateCurrentTime()}),6e4)},checkCourseStatusChanges(e){const t=B(new Date);this.filteredCourses&&Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0&&this.filteredCourses.forEach((a=>{a.day===t&&a.courses&&Array.isArray(a.courses)&&a.courses.forEach((t=>{const a=this.isUpcomingCheckInAtTime(t,e),s=this.isInCheckInTimeWindow(t);if(a&&s&&this.showCheckInNotification(t),s&&"not-checked"===t.status){const e=this.getRemainingCheckInTime(t);e<=3&&e>0&&this.showCheckInWarning(t,e)}}))}))},isUpcomingCheckInAtTime(e,t){const a=60*t.getHours()+t.getMinutes(),s=B(t);if(e.day!==s)return!1;const[n,l]=e.start.split(":").map(Number),i=60*n+l-a;return i>10&&i<=30},showCheckInNotification(e){m({title:`${e.label} ç°åœ¨å¯ä»¥æ‰“å¡äº†ï¼`,icon:"none",duration:3e3}),C&&C()},showCheckInWarning(e,t){m({title:`è­¦å‘Šï¼š${e.label} æ‰“å¡æ—¶é—´è¿˜å‰© ${t} åˆ†é’Ÿï¼`,icon:"none",duration:3e3}),C&&C()},async saveOfflineCheckIn(e){let t={latitude:0,longitude:0,address:"ä½ç½®æœªçŸ¥ (ç¦»çº¿æ¨¡å¼)"};try{t=await this.getCurrentLocation(),console.log("ç¦»çº¿æ¨¡å¼è·å–ä½ç½®:",t)}catch(s){console.error("ç¦»çº¿æ¨¡å¼è·å–ä½ç½®å¤±è´¥:",s)}const a={courseId:e._id,courseName:e.label||e.name,date:J(this.currentTime),startTime:e.start,endTime:e.end,checkInTime:this.currentTime.toISOString(),location:t,userId:H()._id,name:H().name,classId:H().classId,day:e.day};console.log("ä¿å­˜ç¦»çº¿æ‰“å¡è®°å½•:",a);if(!function(e){try{const t=f("offlineCheckIns")||[];return t.push({...e,timestamp:Date.now(),synced:!1}),u("offlineCheckIns",t),!0}catch(t){return!1}}(a))throw new Error("ç¦»çº¿æ‰“å¡ä¿å­˜å¤±è´¥");e.isCheckedIn=!0,e.isOffline=!0,e.status="attended",this.loadOfflineCheckIns(),m({title:"ç¦»çº¿æ‰“å¡å·²ä¿å­˜",icon:"success"})},async syncOfflineCheckIns(){if(await this.checkNetworkStatus(),this.isOffline)return void m({title:"å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•åŒæ­¥",icon:"none"});const e=this.offlineCheckIns.filter((e=>!e.synced));if(0!==e.length){y({title:`æ­£åœ¨åŒæ­¥${e.length}æ¡è®°å½•...`,mask:!0});try{const a=[];for(const l of e)try{const e={courseId:l.courseId,courseName:l.courseName,date:l.date,startTime:l.startTime,endTime:l.endTime,checkInTime:l.checkInTime,location:l.location,isOfflineSync:!0},t=await z(e);t&&0===t.code?(G(l.timestamp,!0),a.push({success:!0,record:l})):a.push({success:!1,record:l,error:(null==t?void 0:t.message)||"åŒæ­¥å¤±è´¥"})}catch(t){a.push({success:!1,record:l,error:t.message||"åŒæ­¥å¤±è´¥"})}this.loadOfflineCheckIns();const s=a.filter((e=>e.success)).length,n=a.length-s;0===n?(m({title:`${s}æ¡è®°å½•åŒæ­¥æˆåŠŸ`,icon:"success"}),function(){try{const e=(f("offlineCheckIns")||[]).filter((e=>!e.synced));u("offlineCheckIns",e)}catch(e){return!1}}()):k(0===s?{title:"åŒæ­¥å¤±è´¥",content:"æ‰€æœ‰è®°å½•åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",showCancel:!1}:{title:"éƒ¨åˆ†åŒæ­¥æˆåŠŸ",content:`å…±${a.length}æ¡è®°å½•ï¼Œ${s}æ¡åŒæ­¥æˆåŠŸï¼Œ${n}æ¡å¤±è´¥`,confirmText:"çŸ¥é“äº†",showCancel:!1})}catch(a){m({title:"åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯",icon:"none"})}finally{g()}}else m({title:"æ²¡æœ‰éœ€è¦åŒæ­¥çš„è®°å½•",icon:"none"})},setupNetworkListener(){h({success:e=>{this.isOffline="none"===e.networkType}}),S((e=>{const t=this.isOffline;this.isOffline=!e.isConnected,t&&!this.isOffline&&this.syncOfflineCheckIns()}))},loadOfflineCheckIns(){this.offlineCheckIns=function(){try{return(f("offlineCheckIns")||[]).filter((e=>!e.synced))}catch(e){return[]}}()},isLateCheckIn(e,t){const a=t?new Date(t):new Date,[s,n]=e.start.split(":").map(Number),l=new Date(a);return l.setHours(s,n,0,0),a>l},updateAttendanceStatus(e,t){this.$set(e,"status","attended"),this.$set(e,"attendanceTime",t||(new Date).toISOString());const a=this.isLateCheckIn(e,t);this.$set(e,"isLate",a),this.$forceUpdate()},getCurrentLocation:()=>new Promise(((e,t)=>{w({type:"gcj02",success:t=>{const a={latitude:t.latitude,longitude:t.longitude,address:`çº¬åº¦: ${t.latitude}, ç»åº¦: ${t.longitude}`};console.log("è·å–ä½ç½®æˆåŠŸ:",a),e(a)},fail:t=>{console.error("è·å–ä½ç½®å¤±è´¥:",t),e({latitude:0,longitude:0,address:"ä½ç½®æœªçŸ¥ (è¯·æ£€æŸ¥ä½ç½®æƒé™)"})}})})),async checkNetworkStatus(){this.isOffline=!(await new Promise((e=>{h({success:t=>{e("none"!==t.networkType)},fail:()=>{e(!1)}})})))},updateCoursesStatus(){this.myAttendanceList&&0!==this.myAttendanceList.length&&this.myAttendanceList.forEach((e=>{if(e.leaveId&&!e.leaveStatus&&("attended"!==e.status&&(e.status="not-checked"),e.leaveId=null,e.leaveReason=null,this.leaveSubmitted[this.getCourseKey(e)]&&(delete this.leaveSubmitted[this.getCourseKey(e)],this.saveLeaveSubmitted())),e.start&&e.end){const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=B(t),[n,l]=e.start.split(":").map(Number),[i,r]=e.end.split(":").map(Number),c=new Date(a);c.setHours(n,l,0,0);const d=new Date(a);d.setHours(i,r,0,0);const o=new Date(c);o.setHours(o.getHours()-1);const u=new Date(d);u.setHours(u.getHours()+1),e.isWithinCheckInWindow=t>=o&&t<=u&&e.day===s;const h=new Date(c);h.setMinutes(h.getMinutes()-30),e.isUpcoming=t>=h&&t<c&&e.day===s;const f=new Date(u);f.setMinutes(f.getMinutes()-10),e.isWindowClosingSoon=t>=f&&t<u&&e.day===s,e.isExpired=e.day!==s&&this.getDayIndex(e.day)<this.getDayIndex(s)||e.day===s&&t>d}}))},getStatusText(e){if(e.isOffline)return"ç¦»çº¿æ‰“å¡";switch(e.status){case"attended":return e.isLate?"è¿Ÿåˆ°":"å·²æ‰“å¡";case"not-checked":return"æœªæ‰“å¡";case"leave":return"å·²è¯·å‡";case"absent":return"æ—·è¯¾";default:return"æœªçŸ¥çŠ¶æ€"}},getWindowRemainingTime(e){if(!e||!e.start||!e.end)return"00:00";const t=new Date,a=new Date,[s,n]=e.start.split(":").map(Number);a.setHours(s,n,0,0);const l=new Date(a);l.setMinutes(l.getMinutes()+10);const i=l-t;if(i<=0)return"00:00";const r=Math.floor(i/6e4),c=Math.floor(i%6e4/1e3);return`${String(r).padStart(2,"0")}:${String(c).padStart(2,"0")}`},formatDate(e){if(!e)return"";return`${e.getFullYear()}å¹´${e.getMonth()+1}æœˆ${e.getDate()}æ—¥ ${B(e)}`},formatTime(e){if(!e)return"";if(e instanceof Date)return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`;if("string"==typeof e&&e.includes("T")){const t=new Date(e);return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}return e},forceUpdate(){this.updateCollapsedState(),this.$forceUpdate()},updateCollapsedState(){if(!this.filteredCourses)return;const e=new Date,t=this.$attendance.getDayOfWeek(e),a={};Object.keys(this.filteredCourses).forEach((e=>{a[e]=!0,e===t&&(a[e]=!1)})),this.collapsedDays=a},scrollToCheckInCourse(){const e=B(new Date);this.$set(this.collapsedDays,e,!1);const t=this.myAttendanceList.find((t=>t.day===e&&"not-checked"===t.status&&this.isInCheckInTimeWindow(t)));t&&this.$nextTick((()=>{const e=document.querySelectorAll(".course-item");let a=null;e.forEach((e=>{var s,n;const l=null==(s=e.querySelector(".course-name"))?void 0:s.textContent,i=null==(n=e.querySelector(".course-time"))?void 0:n.textContent;l===t.label&&i.includes(t.start)&&i.includes(t.end)&&(a=e)})),a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.classList.add("highlight-course"),setTimeout((()=>{a.classList.remove("highlight-course")}),2e3))}))},loadLeaveSubmitted(){try{const e=f("leave_submitted");e&&(this.leaveSubmitted=JSON.parse(e))}catch(e){this.leaveSubmitted={}}},saveLeaveSubmitted(){try{u("leave_submitted",JSON.stringify(this.leaveSubmitted))}catch(e){m({title:"ä¿å­˜è¯·å‡è®°å½•å¤±è´¥",icon:"none"})}},async checkLeaveStatus(){const e=this.myAttendanceList.filter((e=>e.leaveId));if(0!==e.length)try{const t=e.map((e=>e.leaveId)),a=await o.callFunction({name:"leave",data:{action:"getByIds",ids:t,status:["approved","pending"]}});a.result&&200===a.result.code&&a.result.data&&(e.forEach((e=>{const t=a.result.data.find((t=>t._id===e.leaveId));t?(e.leaveStatus=t.status,"attended"!==e.status&&(e.status="leave")):("attended"!==e.status&&(e.status="not-checked"),e.leaveStatus=null,e.leaveId=null,e.leaveReason=null,this.leaveSubmitted[this.getCourseKey(e)]&&(delete this.leaveSubmitted[this.getCourseKey(e)],this.saveLeaveSubmitted()))})),this.updateCoursesStatus())}catch(t){console.error("æ£€æŸ¥è¯·å‡çŠ¶æ€å¤±è´¥:",t)}}},async created(){await this.getCurrentWeekNumber(),await this.checkNetworkStatus(),this.loadOfflineCheckIns(),this.loadLeaveSubmitted(),await this.checkLeaveStatus(),this.updateCoursesStatus(),S((e=>{this.isOffline=!e.isConnected,!this.isOffline&&this.offlineCheckIns.length>0&&k({title:"ç½‘ç»œå·²æ¢å¤",content:`æ£€æµ‹åˆ°${this.offlineCheckIns.length}æ¡æœªåŒæ­¥çš„æ‰“å¡è®°å½•ï¼Œæ˜¯å¦ç«‹å³åŒæ­¥ï¼Ÿ`,confirmText:"ç«‹å³åŒæ­¥",cancelText:"ç¨ååŒæ­¥",success:e=>{e.confirm&&this.syncOfflineCheckIns()}}),this.isOffline||(this.checkLeaveStatus(),this.updateCoursesStatus())})),this.timeUpdateInterval=setInterval((()=>{this.currentTime=new Date,this.updateCoursesStatus(),this.currentTime.getMinutes()%5!=0||this.isOffline||this.checkLeaveStatus()}),6e4),this.$nextTick((()=>{const e=B(new Date);this.filteredCourses&&Array.isArray(this.filteredCourses)&&this.filteredCourses.length>0&&this.filteredCourses.forEach((t=>{this.$set(this.collapsedDays,t.day,t.day!==e)}))}))},beforeDestroy(){this.timeUpdateInterval&&clearInterval(this.timeUpdateInterval)}},[["render",function(e,o,u,h,f,m){const y=d,g=c,p=L,k=$,C=D(b("uni-icons"),_);return t(),a(y,{class:"student-attendance"},{default:s((()=>[m.hasCheckInCourse?(t(),a(y,{key:0,class:"check-in-tip"},{default:s((()=>[n(y,{class:"tip-icon"},{default:s((()=>[i("ğŸ“¢")])),_:1}),n(y,{class:"tip-content"},{default:s((()=>[n(g,null,{default:s((()=>[i("æ‚¨æœ‰è¯¾ç¨‹å¯ä»¥æ‰“å¡ï¼š"+r(m.checkInCourseName),1)])),_:1}),n(g,{class:"tip-time"},{default:s((()=>[i(r(m.checkInTimeRemaining),1)])),_:1})])),_:1}),n(y,{class:"tip-action",onClick:m.scrollToCheckInCourse},{default:s((()=>[n(g,null,{default:s((()=>[i("å»æ‰“å¡")])),_:1})])),_:1},8,["onClick"])])),_:1})):v("",!0),f.isOffline?(t(),a(y,{key:1,class:"offline-notice"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"offline-icon"},{default:s((()=>[i("âš ï¸")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,null,{default:s((()=>[i("å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ‰“å¡è®°å½•å°†åœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨æäº¤")])),_:1})])),_:1})])),_:1})):v("",!0),!f.isOffline&&m.pendingSyncCount>0?(t(),a(y,{key:2,class:"offline-sync-notice",onClick:m.syncOfflineCheckIns},{default:s((()=>[n(y,null,{default:s((()=>[n(g,null,{default:s((()=>[i("æ‚¨æœ‰ "+r(m.pendingSyncCount)+" æ¡ç¦»çº¿æ‰“å¡è®°å½•å¾…åŒæ­¥",1)])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"sync-button"},{default:s((()=>[i("ç«‹å³åŒæ­¥")])),_:1})])),_:1})])),_:1},8,["onClick"])):v("",!0),f.showLeaveForm?(t(),a(y,{key:3,class:"leave-form-popup"},{default:s((()=>[n(y,{class:"leave-form-content"},{default:s((()=>[n(y,{class:"form-title"},{default:s((()=>[i("ç”³è¯·è¯·å‡")])),_:1}),n(y,{class:"form-item"},{default:s((()=>[n(g,{class:"form-label"},{default:s((()=>[i("è¯·å‡è¯¾ç¨‹")])),_:1}),n(g,{class:"form-value"},{default:s((()=>[i(r(f.currentCourse.label)+" ("+r(f.currentCourse.start)+"-"+r(f.currentCourse.end)+")",1)])),_:1})])),_:1}),n(y,{class:"form-item"},{default:s((()=>[n(g,{class:"form-label"},{default:s((()=>[i("è¯·å‡ç†ç”±")])),_:1}),n(p,{class:"form-textarea",modelValue:f.leaveReason,"onUpdate:modelValue":o[0]||(o[0]=e=>f.leaveReason=e),placeholder:"è¯·è¾“å…¥è¯·å‡ç†ç”±",maxlength:100},null,8,["modelValue"])])),_:1}),n(y,{class:"form-actions"},{default:s((()=>[n(k,{class:"cancel-btn",onClick:m.cancelLeave},{default:s((()=>[i("å–æ¶ˆ")])),_:1},8,["onClick"]),n(k,{class:"submit-btn",onClick:m.submitLeave,disabled:!f.leaveReason||f.isSubmittingLeave},{default:s((()=>[i(r(f.isSubmittingLeave?"æäº¤ä¸­...":"æäº¤"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1})):v("",!0),(t(!0),I(T,null,A(m.filteredCourses,((e,c)=>(t(),a(y,{key:c,class:"day-group"},{default:s((()=>[n(y,{class:"day-header",onClick:t=>m.toggleDayCollapse(e.day)},{default:s((()=>[n(y,{class:"day-title"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"day-name"},{default:s((()=>[i(r(e.day),1)])),_:2},1024)])),_:2},1024),n(y,null,{default:s((()=>[n(g,{class:"day-date"},{default:s((()=>{var t;return[i(r(null==(t=e.courses[0])?void 0:t.formattedDate),1)]})),_:2},1024)])),_:2},1024)])),_:2},1024),n(y,{class:"day-icon"},{default:s((()=>[n(C,{type:f.collapsedDays[e.day]?"right":"down",size:"16",color:"#666"},null,8,["type"])])),_:2},1024)])),_:2},1032,["onClick"]),f.collapsedDays[e.day]?v("",!0):(t(),a(y,{key:0,class:"course-list"},{default:s((()=>[(t(!0),I(T,null,A(e.courses,((e,c)=>(t(),a(y,{key:c,class:l(["course-item",{attended:"attended"===e.status&&!e.isOffline,"not-checked":"not-checked"===e.status,leave:"leave"===e.status,future:e.isFuture,past:e.isPast,expired:m.isExpired(e),collapsed:m.isCollapsible(e)&&f.collapsedCourses[m.getCourseKey(e)],late:e.isLate&&"attended"===e.status,absent:m.isExpired(e)&&"not-checked"===e.status,"check-in-window":m.isInCheckInTimeWindow(e),"upcoming-check-in":m.isUpcomingCheckIn(e),offline:e.isOffline}])},{default:s((()=>[n(y,{class:"course-header",onClick:t=>m.toggleCourseCollapse(e)},{default:s((()=>[n(y,{class:"course-info"},{default:s((()=>[n(y,{class:"course-time"},{default:s((()=>[i(r(m.formatTime(e.start))+" - "+r(m.formatTime(e.end)),1)])),_:2},1024),n(y,{class:"course-name"},{default:s((()=>[i(r(e.label),1)])),_:2},1024),m.isCollapsible(e)&&f.collapsedCourses[m.getCourseKey(e)]?(t(),a(y,{key:0,class:"collapsed-status"},{default:s((()=>[n(y,{class:l(["status-badge",m.getStatusClass(e)])},{default:s((()=>[i(r(m.getStatusText(e)),1)])),_:2},1032,["class"])])),_:2},1024)):v("",!0)])),_:2},1024),m.isCollapsible(e)&&f.collapsedCourses[m.getCourseKey(e)]?v("",!0):(t(),a(y,{key:0,class:"course-actions"},{default:s((()=>[n(y,{class:l(["status-badge",m.getStatusClass(e)])},{default:s((()=>[i(r(m.getStatusText(e)),1)])),_:2},1032,["class"]),m.isExpired(e)||e.isFuture?v("",!0):(t(),a(y,{key:0,class:"action-buttons"},{default:s((()=>[n(y,{class:l(["action-button attended",{active:"attended"===e.status}]),onClick:W((t=>m.updateStatus(e,"attended")),["stop"])},{default:s((()=>[n(g,{class:"iconfont icon-attended"})])),_:2},1032,["class","onClick"]),n(y,{class:l(["action-button leave",{active:"leave"===e.status}]),onClick:W((t=>m.updateStatus(e,"leave")),["stop"])},{default:s((()=>[n(g,{class:"iconfont icon-leave"})])),_:2},1032,["class","onClick"])])),_:2},1024))])),_:2},1024)),m.isCollapsible(e)?(t(),a(y,{key:1,class:"collapse-indicator"},{default:s((()=>[n(g,{class:l(["iconfont",f.collapsedCourses[m.getCourseKey(e)]?"icon-arrow-down":"icon-arrow-up"])},null,8,["class"])])),_:2},1024)):v("",!0)])),_:2},1032,["onClick"]),m.isCollapsible(e)&&f.collapsedCourses[m.getCourseKey(e)]?v("",!0):(t(),a(y,{key:0,class:"course-content"},{default:s((()=>[n(y,{class:"course-details"},{default:s((()=>[e.teacher?(t(),a(y,{key:0,class:"detail-item"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("æˆè¯¾æ•™å¸ˆï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(e.teacher),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):v("",!0),e.location?(t(),a(y,{key:1,class:"detail-item"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("ä¸Šè¯¾åœ°ç‚¹ï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(e.location),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):v("",!0),e.week?(t(),a(y,{key:2,class:"detail-item"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("ä¸Šè¯¾å‘¨æ¬¡ï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(e.week),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):v("",!0),e.type?(t(),a(y,{key:3,class:"detail-item"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("è¯¾ç¨‹ç±»å‹ï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(e.type),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):v("",!0)])),_:2},1024),n(y,{class:"course-status"},{default:s((()=>[n(y,{class:"action-buttons"},{default:s((()=>[m.canCheckIn(e)?(t(),a(k,{key:0,class:"check-in-btn",onClick:t=>m.handleCheckIn(e),disabled:u.isSubmitting},{default:s((()=>[i(" æ‰“å¡ ")])),_:2},1032,["onClick","disabled"])):v("",!0),m.canApplyLeave(e)?(t(),a(k,{key:1,class:"leave-btn",onClick:t=>m.handleApplyLeave(e)},{default:s((()=>[i(r(f.leaveSubmitted[m.getCourseKey(e)]&&"cancelled"!==e.leaveStatus&&"rejected"!==e.leaveStatus?"å¤åˆ¶è¯·å‡ç”³è¯·":"è¯·å‡"),1)])),_:2},1032,["onClick"])):v("",!0)])),_:2},1024)])),_:2},1024),"not-checked"!==e.status||m.isExpired(e)||e.isFuture?v("",!0):(t(),a(y,{key:0,class:"check-in-notice"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,null,{default:s((()=>[i("åªèƒ½åœ¨è¯¾å‰1å°æ—¶è‡³è¯¾å1å°æ—¶å†…æ‰“å¡")])),_:1})])),_:1}),m.isInCheckInTimeWindow(e)?(t(),a(y,{key:0},{default:s((()=>[n(g,{class:"countdown"},{default:s((()=>[i(r(m.formatRemainingTime(m.getRemainingCheckInTime(e))),1)])),_:2},1024)])),_:2},1024)):v("",!0)])),_:2},1024)),"attended"===e.status?(t(),a(y,{key:1,class:"attendance-details"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("æ‰“å¡æ—¶é—´ï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(m.formatTime(e.attendanceTime)),1)])),_:2},1024)])),_:2},1024),e.isLate?(t(),a(y,{key:0,class:"late-tag"},{default:s((()=>[n(g,null,{default:s((()=>[i("è¿Ÿåˆ°")])),_:1})])),_:1})):v("",!0)])),_:2},1024)):v("",!0),"leave"===e.status?(t(),a(y,{key:2,class:"attendance-details"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"detail-label"},{default:s((()=>[i("è¯·å‡ç†ç”±ï¼š")])),_:1})])),_:1}),n(y,null,{default:s((()=>[n(g,{class:"detail-value"},{default:s((()=>[i(r(e.leaveReason||"æ— "),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):v("",!0)])),_:2},1024))])),_:2},1032,["class"])))),128))])),_:2},1024))])),_:2},1024)))),128)),m.hasAnyCourses?v("",!0):(t(),a(y,{key:4,class:"empty-state"},{default:s((()=>[n(y,null,{default:s((()=>[n(g,{class:"empty-text"},{default:s((()=>[i("æ²¡æœ‰è¯¾ç¨‹å®‰æ’")])),_:1})])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-a9795bf5"]]),ClassAttendance:e({name:"ClassAttendance",props:{classAttendanceList:{type:Array,required:!0},currentFilter:{type:String,default:"all"},selectedDate:{type:String,default:""},selectedTimeSlot:{type:Object,default:()=>({start:null,end:null})},isLoading:{type:Boolean,default:!1}},data:()=>({attendanceStats:{total:0,attended:0,notChecked:0,leave:0,late:0},selectedStudents:[]}),computed:{filteredStudents(){return"all"===this.currentFilter?this.classAttendanceList:this.classAttendanceList.filter((e=>e.attendanceStatus===this.currentFilter))},stats(){const e={total:this.classAttendanceList.length,attended:0,notChecked:0,leave:0,late:0};return this.classAttendanceList.forEach((t=>{switch(t.attendanceStatus){case"attended":e.attended++,t.isLate&&e.late++;break;case"not-checked":e.notChecked++;break;case"leave":e.leave++}})),e},hasSelectedStudents(){return this.selectedStudents.length>0},isAllSelected(){return this.selectedStudents.length===this.filteredStudents.length&&this.filteredStudents.length>0},formattedDate(){if(!this.selectedDate)return"";const e=new Date(this.selectedDate);return`${e.getFullYear()}å¹´${e.getMonth()+1}æœˆ${e.getDate()}æ—¥ ${B(e)}`},formattedTimeSlot(){return this.selectedTimeSlot.start&&this.selectedTimeSlot.end?`${this.selectedTimeSlot.start} - ${this.selectedTimeSlot.end}`:"å…¨å¤©"}},watch:{classAttendanceList:{handler(e){this.updateStats(),this.selectedStudents=[]},immediate:!0}},methods:{getStatusClass(e){const t=e.attendanceStatus||"not-checked";return"attended"===t&&e.isLate?"late":t},getStatusText(e){switch(e.attendanceStatus){case"attended":return e.isLate?"è¿Ÿåˆ°":"å·²æ‰“å¡";case"not-checked":return"æœªæ‰“å¡";case"leave":return"approved"===e.leaveStatus?"å·²è¯·å‡":"è¯·å‡æœªæ‰¹";default:return"æœªçŸ¥çŠ¶æ€"}},formatTime(e){if(!e)return"";try{const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}catch(t){return e}},getEmptyText(){switch(this.currentFilter){case"attended":return"æš‚æ— å­¦ç”Ÿæ‰“å¡";case"not-checked":return"æ‰€æœ‰å­¦ç”Ÿå·²æ‰“å¡";case"leave":return"æš‚æ— å­¦ç”Ÿè¯·å‡";default:return"æš‚æ— å­¦ç”Ÿæ•°æ®"}},updateStats(){this.attendanceStats=this.stats,this.$emit("stats-update",this.attendanceStats)},handleExport(){const e={date:this.selectedDate,className:"ç­çº§è€ƒå‹¤",startTime:this.selectedTimeSlot.start,endTime:this.selectedTimeSlot.end};this.$emit("export",e)},handleShare(){this.$emit("share")},toggleStudentSelection(e){const t=this.selectedStudents.findIndex((t=>t._id===e._id));-1===t?this.selectedStudents.push(e):this.selectedStudents.splice(t,1)},toggleSelectAll(){this.isAllSelected?this.selectedStudents=[]:this.selectedStudents=[...this.filteredStudents]},batchUpdateStatus(e){if(0===this.selectedStudents.length)return void m({title:"è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ",icon:"none"});const t={studentIds:this.selectedStudents.map((e=>e._id)),status:e,date:this.selectedDate,startTime:this.selectedTimeSlot.start,endTime:this.selectedTimeSlot.end};this.$emit("batch-update",t)},handleStatusUpdate(e,t){const a={studentId:e._id,status:t,date:this.selectedDate,startTime:this.selectedTimeSlot.start,endTime:this.selectedTimeSlot.end};this.$emit("status-update",a)}}},[["render",function(e,o,u,h,f,m){const y=d,g=c,p=$,k=O;return t(),a(y,{class:"class-attendance"},{default:s((()=>[n(y,{class:"attendance-header"},{default:s((()=>[n(y,{class:"date-info"},{default:s((()=>[i(r(m.formattedDate),1)])),_:1}),n(y,{class:"time-slot-info"},{default:s((()=>[i(r(m.formattedTimeSlot),1)])),_:1})])),_:1}),m.hasSelectedStudents?(t(),a(y,{key:0,class:"batch-actions"},{default:s((()=>[n(y,{class:"selection-info"},{default:s((()=>[n(g,null,{default:s((()=>[i("å·²é€‰æ‹© "+r(f.selectedStudents.length)+" åå­¦ç”Ÿ",1)])),_:1}),n(g,{class:"clear-selection",onClick:o[0]||(o[0]=e=>f.selectedStudents=[])},{default:s((()=>[i("æ¸…é™¤")])),_:1})])),_:1}),n(y,{class:"action-buttons"},{default:s((()=>[n(p,{class:"action-btn attended",onClick:o[1]||(o[1]=e=>m.batchUpdateStatus("attended"))},{default:s((()=>[i("æ ‡è®°ä¸ºå·²æ‰“å¡")])),_:1}),n(p,{class:"action-btn leave",onClick:o[2]||(o[2]=e=>m.batchUpdateStatus("leave"))},{default:s((()=>[i("æ ‡è®°ä¸ºè¯·å‡")])),_:1}),n(p,{class:"action-btn not-checked",onClick:o[3]||(o[3]=e=>m.batchUpdateStatus("not-checked"))},{default:s((()=>[i("æ ‡è®°ä¸ºæœªæ‰“å¡")])),_:1})])),_:1})])),_:1})):v("",!0),n(y,{class:"student-list"},{default:s((()=>[n(y,{class:"list-header"},{default:s((()=>[n(y,{class:"select-all",onClick:m.toggleSelectAll},{default:s((()=>[n(k,{checked:m.isAllSelected},null,8,["checked"]),n(g,null,{default:s((()=>[i("å…¨é€‰")])),_:1})])),_:1},8,["onClick"]),n(g,{class:"header-name"},{default:s((()=>[i("å§“å")])),_:1}),n(g,{class:"header-status"},{default:s((()=>[i("çŠ¶æ€")])),_:1}),n(g,{class:"header-time"},{default:s((()=>[i("æ‰“å¡æ—¶é—´")])),_:1}),n(g,{class:"header-actions"},{default:s((()=>[i("æ“ä½œ")])),_:1})])),_:1}),(t(!0),I(T,null,A(m.filteredStudents,((e,c)=>(t(),a(y,{key:c,class:l(["student-item",m.getStatusClass(e)])},{default:s((()=>[n(y,{class:"student-select",onClick:W((t=>m.toggleStudentSelection(e)),["stop"])},{default:s((()=>[n(k,{checked:f.selectedStudents.some((t=>t._id===e._id))},null,8,["checked"])])),_:2},1032,["onClick"]),n(y,{class:"student-info"},{default:s((()=>[n(y,{class:"student-name"},{default:s((()=>[i(r(e.name),1)])),_:2},1024),e.studentId?(t(),a(y,{key:0,class:"student-id"},{default:s((()=>[i(r(e.studentId),1)])),_:2},1024)):v("",!0)])),_:2},1024),n(y,{class:"attendance-status"},{default:s((()=>[n(y,{class:l(["status-badge",m.getStatusClass(e)])},{default:s((()=>[i(r(m.getStatusText(e)),1)])),_:2},1032,["class"])])),_:2},1024),"attended"===e.attendanceStatus?(t(),a(y,{key:0,class:"attendance-time"},{default:s((()=>[i(r(m.formatTime(e.attendanceTime)),1)])),_:2},1024)):(t(),a(y,{key:1,class:"attendance-time"},{default:s((()=>[i(" --:-- ")])),_:1})),n(y,{class:"student-actions"},{default:s((()=>[n(y,{class:"action-icon attended",onClick:t=>m.handleStatusUpdate(e,"attended")},{default:s((()=>[n(g,{class:"iconfont icon-check"})])),_:2},1032,["onClick"]),n(y,{class:"action-icon leave",onClick:t=>m.handleStatusUpdate(e,"leave")},{default:s((()=>[n(g,{class:"iconfont icon-leave"})])),_:2},1032,["onClick"]),n(y,{class:"action-icon not-checked",onClick:t=>m.handleStatusUpdate(e,"not-checked")},{default:s((()=>[n(g,{class:"iconfont icon-close"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1}),0!==m.filteredStudents.length||u.isLoading?v("",!0):(t(),a(y,{key:1,class:"empty-state"},{default:s((()=>[n(g,{class:"empty-text"},{default:s((()=>[i(r(m.getEmptyText()),1)])),_:1})])),_:1})),u.isLoading?(t(),a(y,{key:2,class:"loading-state"},{default:s((()=>[n(g,{class:"loading-text"},{default:s((()=>[i("åŠ è½½ä¸­...")])),_:1})])),_:1})):v("",!0),n(y,{class:"action-buttons footer-actions"},{default:s((()=>[n(p,{class:"export-btn",onClick:m.handleExport},{default:s((()=>[i("å¯¼å‡ºè€ƒå‹¤")])),_:1},8,["onClick"]),n(p,{class:"share-btn",onClick:m.handleShare},{default:s((()=>[i("åˆ†äº«è€ƒå‹¤")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-eed82df7"]]),LeaveRecord:e({name:"LeaveRecord",props:{leaveRecords:{type:Array,default:()=>[]},course:{type:Object,default:()=>({})},showForm:{type:Boolean,default:!1}},data:()=>({reason:""}),methods:{getCourseName(e){if(e.courseTime&&Array.isArray(e.courseTime)){const t={1:"ç¬¬ä¸€èŠ‚è¯¾ (08:30-10:00)",2:"ç¬¬äºŒèŠ‚è¯¾ (10:30-12:00)",3:"ç¬¬ä¸‰èŠ‚è¯¾ (14:00-15:20)",4:"ç¬¬å››èŠ‚è¯¾ (15:30-16:50)",evening:"æ™šè‡ªä¹  (19:00-20:40)"};return e.courseTime.map((e=>t[e]||e)).join(", ")}return e.startTime&&e.endTime?`${e.startTime}-${e.endTime}`:"æœªçŸ¥è¯¾ç¨‹"},formatDate(e){if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},getStatusText(e){switch(e){case"approved":return"å·²æ‰¹å‡†";case"pending":return"å¾…å®¡æ‰¹";case"rejected":return"å·²æ‹’ç»";default:return"æœªçŸ¥çŠ¶æ€"}},handleCancel(){this.reason="",this.$emit("cancel")},handleSubmit(){this.reason?(this.$emit("submit",{reason:this.reason,course:this.course}),this.reason=""):m({title:"è¯·è¾“å…¥è¯·å‡ç†ç”±",icon:"none"})}}},[["render",function(e,o,u,h,f,m){const y=d,g=c,p=L,k=$;return t(),a(y,{class:"leave-record"},{default:s((()=>[u.showForm?(t(),a(y,{key:0,class:"leave-form"},{default:s((()=>[n(y,{class:"form-title"},{default:s((()=>[i("ç”³è¯·è¯·å‡")])),_:1}),n(y,{class:"form-item"},{default:s((()=>[n(g,{class:"form-label"},{default:s((()=>[i("è¯·å‡è¯¾ç¨‹")])),_:1}),n(g,{class:"form-value"},{default:s((()=>[i(r(u.course.label)+" ("+r(u.course.start)+"-"+r(u.course.end)+")",1)])),_:1})])),_:1}),n(y,{class:"form-item"},{default:s((()=>[n(g,{class:"form-label"},{default:s((()=>[i("è¯·å‡ç†ç”±")])),_:1}),n(p,{class:"form-textarea",modelValue:f.reason,"onUpdate:modelValue":o[0]||(o[0]=e=>f.reason=e),placeholder:"è¯·è¾“å…¥è¯·å‡ç†ç”±",maxlength:100},null,8,["modelValue"])])),_:1}),n(y,{class:"form-actions"},{default:s((()=>[n(k,{class:"cancel-btn",onClick:m.handleCancel},{default:s((()=>[i("å–æ¶ˆ")])),_:1},8,["onClick"]),n(k,{class:"submit-btn",onClick:m.handleSubmit,disabled:!f.reason},{default:s((()=>[i("æäº¤")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})):(t(),a(y,{key:1,class:"leave-list"},{default:s((()=>[n(y,{class:"list-title"},{default:s((()=>[i("è¯·å‡è®°å½•")])),_:1}),(t(!0),I(T,null,A(u.leaveRecords,((e,c)=>(t(),a(y,{key:c,class:l(["leave-item",{approved:"approved"===e.status,pending:"pending"===e.status,rejected:"rejected"===e.status}])},{default:s((()=>[n(y,{class:"leave-info"},{default:s((()=>[n(y,{class:"leave-course"},{default:s((()=>[i(r(m.getCourseName(e)),1)])),_:2},1024),n(y,{class:"leave-time"},{default:s((()=>[i(r(m.formatDate(e.createTime)),1)])),_:2},1024)])),_:2},1024),n(y,{class:"leave-reason"},{default:s((()=>[n(g,{class:"reason-label"},{default:s((()=>[i("è¯·å‡ç†ç”±ï¼š")])),_:1}),n(g,{class:"reason-content"},{default:s((()=>[i(r(e.reason||"æ— ç†ç”±"),1)])),_:2},1024)])),_:2},1024),n(y,{class:"leave-status"},{default:s((()=>[n(y,{class:l(["status-badge",e.status])},{default:s((()=>[i(r(m.getStatusText(e.status)),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1032,["class"])))),128)),0===u.leaveRecords.length?(t(),a(y,{key:0,class:"empty-state"},{default:s((()=>[n(g,{class:"empty-text"},{default:s((()=>[i("æš‚æ— è¯·å‡è®°å½•")])),_:1})])),_:1})):v("",!0)])),_:1}))])),_:1})}],["__scopeId","data-v-539b31bd"]]),AttendanceFilter:e({name:"AttendanceFilter",props:{selectedDate:{type:String,required:!0},classSchedule:{type:Array,default:()=>[]},selectedClass:{type:Object,default:null},showClassFilter:{type:Boolean,default:!0},courses:{type:Array,default:()=>[]},selectedCourse:{type:Object,default:null}},computed:{selectedClassIndex(){return this.selectedClass?this.classSchedule.findIndex((e=>e.start===this.selectedClass.start&&e.end===this.selectedClass.end)):0},selectedCourseIndex(){return this.selectedCourse?this.courses.findIndex((e=>e.id===this.selectedCourse.id)):0}},methods:{handleDateChange(e){this.$emit("date-change",e)},handleClassChange(e){const t=e.detail.value,a=this.classSchedule[t];this.$emit("class-change",a)},handleCourseChange(e){const t=e.detail.value,a=this.courses[t];this.$emit("course-change",a)}}},[["render",function(e,l,o,u,h,f){const m=D(b("uni-datetime-picker"),E),y=d,g=c,p=D(b("uni-icons"),_),k=M;return t(),a(y,{class:"filter-container"},{default:s((()=>[n(y,{class:"date-filter"},{default:s((()=>[n(m,{type:"date",value:o.selectedDate,onChange:f.handleDateChange,border:!1,"clear-icon":!1},null,8,["value","onChange"])])),_:1}),o.courses&&o.courses.length>0?(t(),a(y,{key:0,class:"course-filter"},{default:s((()=>[n(k,{value:f.selectedCourseIndex,range:o.courses,"range-key":"name",onChange:f.handleCourseChange},{default:s((()=>[n(y,{class:"picker-content"},{default:s((()=>[n(g,{class:"picker-label"},{default:s((()=>[i(r(o.selectedCourse?o.selectedCourse.name:"å…¨éƒ¨è¯¾ç¨‹"),1)])),_:1}),n(p,{type:"bottom",size:"14",color:"#666"})])),_:1})])),_:1},8,["value","range","onChange"])])),_:1})):v("",!0),o.showClassFilter?(t(),a(y,{key:1,class:"class-filter"},{default:s((()=>[n(k,{value:f.selectedClassIndex,range:o.classSchedule,"range-key":"label",onChange:f.handleClassChange},{default:s((()=>[n(y,{class:"picker-content"},{default:s((()=>[n(g,{class:"picker-label"},{default:s((()=>[i(r(o.selectedClass?o.selectedClass.label:"å…¨éƒ¨è¯¾æ—¶"),1)])),_:1}),n(p,{type:"bottom",size:"14",color:"#666"})])),_:1})])),_:1},8,["value","range","onChange"])])),_:1})):v("",!0)])),_:1})}],["__scopeId","data-v-90a72234"]])},data:()=>({user:{},currentTab:0,tabItems:[],attendanceList:[],classAttendanceList:[],filteredClassAttendanceList:[],loading:!1,selectedDate:U(new Date),selectedClass:null,classSchedule:[{start:null,end:null,label:"å…¨éƒ¨è¯¾æ—¶"},{start:"08:30",end:"10:00",label:"ç¬¬ä¸€èŠ‚è¯¾"},{start:"10:30",end:"12:00",label:"ç¬¬äºŒèŠ‚è¯¾"},{start:"14:00",end:"15:20",label:"ç¬¬ä¸‰èŠ‚è¯¾"},{start:"15:30",end:"16:50",label:"ç¬¬å››èŠ‚è¯¾"},{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ "}],error:!1,classStudents:[],leaveRecords:[],stats:{total:0,attended:0,notChecked:0,leave:0},myAttendanceList:[],days:["æ˜ŸæœŸå¤©","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”"],timeSlots:["08:30-10:00","10:30-12:00","14:00-15:20","15:30-16:50","19:00-20:40"],rawClassSchedule:[],isSubmitting:!1,lastSubmitTime:0,currentFilter:"all",currentWeekOffset:0,attendanceKey:Date.now(),weekDateRange:"",currentWeekNumber:1,showStudentAttendance:!0,localWeekNumber:1}),computed:{isStudent(){var e;return null==(e=this.user.role)?void 0:e.includes("student")},isMonitor(){var e,t,a,s;return(null==(e=this.user.role)?void 0:e.includes("monitor"))||(null==(t=this.user.role)?void 0:t.includes("discipline"))||(null==(a=this.user.role)?void 0:a.includes("instructor"))||(null==(s=this.user.role)?void 0:s.includes("admin"))},periodMap:()=>({1:"08:30-10:00",2:"10:30-12:00",3:"14:00-15:20",4:"15:30-16:50",evening:"19:00-20:40"})},onLoad(){try{const e=H();if(!e)return void N({url:"/pages/auth/login"});this.user=e,this.currentWeekOffset=0,this.initTabItems(),setTimeout((async()=>{try{await se(this.user.classId)}catch(e){console.error("è·å–å¼€å­¦æ—¥æœŸå¤±è´¥:",e)}this.loadClassSchedule(),this.loadData(),this.isMonitor&&this.initClassStudents().then((()=>{this.loadClassAttendance()}))}),100)}catch(e){console.error("onLoadæ‰§è¡Œå¤±è´¥:",e),m({title:"åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},methods:{initTabItems(){this.tabItems=[],this.isStudent&&this.tabItems.push("æˆ‘çš„æ‰“å¡è®°å½•"),this.isMonitor&&this.tabItems.push("ç­çº§æ‰“å¡è®°å½•")},handleTabChange(e){const t=e.currentIndex;this.currentTab=t,this.loadData(!0)},handleDateChange(e){console.log("æ—¥æœŸå˜æ›´:",e),this.selectedDate=e,this.loadClassAttendance(e,this.selectedClass)},resetDate(){console.log("é‡ç½®æ—¥æœŸ");const e=U(new Date);this.selectedDate=e,this.loadClassAttendance(e,this.selectedClass)},handleClassChange(e){const t=e.detail.value,a=this.classSchedule[t];console.log("è¯¾æ—¶å˜æ›´:",a),this.selectedClass=a,"å…¨éƒ¨è¯¾æ—¶"===this.selectedClass.label&&(this.selectedClass=null),this.loadClassAttendance(this.selectedDate,this.selectedClass)},handleFilterChange(e){this.currentFilter=e,this.filterClassAttendance()},async loadClassSchedule(){try{try{const e=await o.callFunction({name:"class_table",data:{action:"get",classId:this.user.classId}});e.result&&200===e.result.code&&e.result.data?e.result.data._id===this.user.classId&&Array.isArray(e.result.data.schedule)?this.rawClassSchedule=e.result.data.schedule:this.rawClassSchedule=e.result.data.schedule||[]:this.useStaticSchedule()}catch(e){console.error("è·å–è¯¾ç¨‹è¡¨å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:",e),this.useStaticSchedule()}this.$nextTick((()=>{this.initMyAttendanceList()}))}catch(e){console.error("åŠ è½½è¯¾ç¨‹è¡¨å¤±è´¥:",e),this.useStaticSchedule(),this.$nextTick((()=>{this.initMyAttendanceList()}))}},useStaticSchedule(){const e=this.user.classId&&"object"==typeof this.user.classId?this.user.classId:null;e&&Array.isArray(e.schedule)&&e.schedule.length>0?this.rawClassSchedule=e.schedule:this.rawClassSchedule=[{day:"æ˜ŸæœŸå¤©",courses:[{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ è¯¾",teacher:"",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸä¸€",courses:[{start:"08:30",end:"10:00",label:"ç—…ç†å­¦ä¸ç—…ç†ç”Ÿç†å­¦",type:"ç†è®º",teacher:"åˆ˜ç’è€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"ä¸­è¯å­¦",type:"ç†è®º",teacher:"å½­ç‘¶è€å¸ˆ",location:"",week:"1-18"},{start:"14:00",end:"15:20",label:"å¤§å­¦è‹±è¯­2",type:"ç†è®º",teacher:"é‚“å©§è€å¸ˆ",location:"é—®ç´ æ¥¼åˆç­503",week:"1-18"},{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ ",teacher:"",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸäºŒ",courses:[{start:"08:30",end:"10:00",label:"ä¸­åŒ»è¯Šæ–­å­¦",type:"ç†è®º",teacher:"å¾ä¸½é™è€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"è¯ç†å­¦",type:"ç†è®º",teacher:"æœåé’°è€å¸ˆ",location:"",week:"1-18"},{start:"14:00",end:"15:20",label:"è¯Šæ–­å­¦",type:"ç†è®º",teacher:"æèè€å¸ˆ",location:"",week:"1-18"},{start:"15:30",end:"16:50",label:"å›½å®¶å®‰å…¨æ•™è‚²",type:"ç†è®º",teacher:"æèˆ’",location:"",week:"9-17"},{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ ",teacher:"",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸä¸‰",courses:[{start:"08:30",end:"10:00",label:"ä¸­è¯å­¦",type:"ç†è®º",teacher:"å½­ç‘¶è€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"æ¯›æ³½ä¸œæ€æƒ³å’Œä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“ç³»æ¦‚è®º",type:"ç†è®º",teacher:"è°¢é›…ç’è€å¸ˆ",location:"",week:"1-18"},{start:"14:00",end:"15:20",label:"è¯Šæ–­å­¦",type:"ç†è®º",teacher:"æèè€å¸ˆ",location:"",week:"1-18"},{start:"15:30",end:"16:50",label:"ä½“è‚²ä¸å¥åº·2",type:"ç†è®º",teacher:"å½­å®‡éº’",location:"",week:"1-18"},{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ ",teacher:"",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸå››",courses:[{start:"08:30",end:"10:00",label:"ä¿¡æ¯æŠ€æœ¯2",type:"ç†è®º",teacher:"é‚¬æ€å¨œè€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"ç—…ç†å­¦ä¸ç—…ç†ç”Ÿç†å­¦",type:"ç†è®º",teacher:"åˆ˜ç’è€å¸ˆ",location:"",week:"1-18"},{start:"14:00",end:"15:20",label:"çº¢è‰²æ–‡åŒ–",type:"ç†è®º",teacher:"æ¨ç«‹åè€å¸ˆ",location:"",week:"14-18"},{start:"15:30",end:"16:50",label:"å½¢åŠ¿ä¸æ”¿ç­–2",type:"ç†è®º",teacher:"ç‹å™è‰¯",location:"",week:"12-16"},{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ ",teacher:"",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸäº”",courses:[{start:"08:30",end:"10:00",label:"è¯ç†å­¦",type:"ç†è®º",teacher:"æœåé’°è€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"ä¸­åŒ»è¯Šæ–­å­¦",type:"ç†è®º",teacher:"å¾ä¸½é™è€å¸ˆ",location:"",week:"1-18"},{start:"14:00",end:"15:20",label:"è¯Šæ–­å­¦",type:"ç†è®º",teacher:"æèè€å¸ˆ",location:"",week:"1-18"}]}]},async initMyAttendanceList(){try{const t=new Date,a=60*t.getHours()+t.getMinutes(),s=U(t),n=await this.getWeekStartDate(this.currentWeekOffset);let l=1;try{if(n){const e=await se(this.user.classId),t=new Date(e),a=Math.abs(n-t),s=Math.floor(a/864e5);l=Math.floor(s/7)+1,this.currentWeekNumber=l}}catch(e){this.currentWeekNumber=1}const i={};if(n)for(let e=0;e<7;e++){const t=new Date(n);t.setDate(n.getDate()+e);const a=B(t),s=U(t);i[a]={date:s,dateObj:t,formattedDate:`${t.getMonth()+1}æœˆ${t.getDate()}æ—¥`}}if(Array.isArray(this.rawClassSchedule)&&this.rawClassSchedule.length>0){const e=[];if(this.rawClassSchedule.forEach((t=>{if(!t||!t.day||!Array.isArray(t.courses))return;const n=i[t.day];if(!n)return;t.courses.filter((e=>this.isInCurrentWeek(e,l))).forEach((l=>{const[i,r]=l.start.split(":").map(Number),[c,d]=l.end.split(":").map(Number),o=60*i+r,u=60*c+d;let h=!1,f=!1,m=!1;n.date===s?a>u?h=!0:a<o?f=!0:m=!0:n.dateObj<new Date(s)?h=!0:f=!0,e.push({...l,day:t.day,date:n.date,formattedDate:n.formattedDate,isPast:h,isFuture:f,isNow:m,status:"not-checked",weekDate:n.date})}))})),0===e.length){const e=this.createDefaultCourses(i,l,s,a);this.myAttendanceList=e}else this.myAttendanceList=e;await this.updateAttendanceStatus()}else{console.warn("myAttendanceListæ— æ•ˆæˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯¾ç¨‹æ•°æ®");const e=this.createDefaultCourses(i,l,s,a);this.myAttendanceList=e}}catch(e){if(console.error("åˆå§‹åŒ–è€ƒå‹¤åˆ—è¡¨å¤±è´¥:",e),!Array.isArray(this.myAttendanceList)){console.warn("myAttendanceListæ— æ•ˆæˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯¾ç¨‹æ•°æ®");const e=new Date,a=60*e.getHours()+e.getMinutes(),s=U(e),n=await this.getWeekStartDate(this.currentWeekOffset);let l=1;try{if(n){const e=await se(this.user.classId),t=new Date(e),a=Math.abs(n-t),s=Math.floor(a/864e5);l=Math.floor(s/7)+1,this.currentWeekNumber=l}}catch(t){console.error("è®¡ç®—å‘¨æ¬¡å¤±è´¥:",t),this.currentWeekNumber=1}const i={};if(n)for(let t=0;t<7;t++){const e=new Date(n);e.setDate(n.getDate()+t);const a=B(e),s=U(e);i[a]={date:s,dateObj:e,formattedDate:`${e.getMonth()+1}æœˆ${e.getDate()}æ—¥`}}const r=this.createDefaultCourses(i,l,s,a);this.myAttendanceList=r}}},createDefaultCourses(e,t,a,s){const n=[];return[{day:"æ˜ŸæœŸä¸€",courses:[{start:"08:30",end:"10:00",label:"ç—…ç†å­¦ä¸ç—…ç†ç”Ÿç†å­¦",type:"ç†è®º",teacher:"åˆ˜ç’è€å¸ˆ",location:"",week:"1-18"},{start:"10:30",end:"12:00",label:"ä¸­è¯å­¦",type:"ç†è®º",teacher:"å½­ç‘¶è€å¸ˆ",location:"",week:"1-18"}]},{day:"æ˜ŸæœŸä¸‰",courses:[{start:"14:00",end:"15:20",label:"å¤§å­¦è‹±è¯­2",type:"ç†è®º",teacher:"é‚“å©§è€å¸ˆ",location:"é—®ç´ æ¥¼åˆç­503",week:"1-18"}]},{day:"æ˜ŸæœŸäº”",courses:[{start:"19:00",end:"20:40",label:"æ™šè‡ªä¹ ",type:"è‡ªä¹ ",teacher:"",location:"",week:"1-18"}]}].forEach((l=>{if(!l||!l.day||!Array.isArray(l.courses))return;const i=e[l.day];if(!i)return;l.courses.filter((e=>this.isInCurrentWeek(e,t))).forEach((e=>{const[t,r]=e.start.split(":").map(Number),[c,d]=e.end.split(":").map(Number),o=60*t+r,u=60*c+d;let h=!1,f=!1,m=!1;i.date===a?s>u?h=!0:s<o?f=!0:m=!0:i.dateObj<new Date(a)?h=!0:f=!0,n.push({...e,day:l.day,date:i.date,formattedDate:i.formattedDate,isPast:h,isFuture:f,isNow:m,status:"not-checked",weekDate:i.date})}))})),n},getDayIndex:e=>({"æ˜ŸæœŸå¤©":7,"æ˜ŸæœŸä¸€":1,"æ˜ŸæœŸäºŒ":2,"æ˜ŸæœŸä¸‰":3,"æ˜ŸæœŸå››":4,"æ˜ŸæœŸäº”":5,"æ˜ŸæœŸå…­":6,"æ˜ŸæœŸæ—¥":0}[e]||0),calculateCurrentWeek(){try{let e;const t=f("startDate");e=t?new Date(t):new Date("2025/2/17");const a=new Date,s=Math.abs(a-e),n=Math.ceil(s/864e5);return Math.floor(n/7)+1}catch(e){return console.error("è®¡ç®—å½“å‰å‘¨æ¬¡å¤±è´¥:",e),1}},isInCurrentWeek(e,t){if(!e||!e.week)return!0;try{const a=e.week.split("-");if(2===a.length){const e=parseInt(a[0])||1,s=parseInt(a[1])||18;return t>=e&&t<=s}if(1===a.length){return t===(parseInt(a[0])||1)}return!0}catch(a){return console.error("è§£æå‘¨æ¬¡å¤±è´¥:",a),!0}},async loadData(e=!1){if(!this.loading||e){this.loading=!0;try{const{startDate:e,endDate:t}=this.getWeekDateRange(this.currentWeekOffset);if(0===this.currentTab&&this.isStudent){const a=await async function(e,t,a,s,n,l){try{const i={action:"getStudentAttendance",userId:e};n&&l?(i.startDate=n,i.endDate=l):t&&(i.date=t),a&&(i.startTime=a),s&&(i.endTime=s);const r=await o.callFunction({name:"attendance",data:i});return r.result&&200===r.result.code&&r.result.data?r.result.data:j(e,t)}catch(i){return j(e,t)}}(this.user._id,null,null,null,e,t);this.attendanceList=a||[];const s=await Y(this.user._id,null,e,t);this.leaveRecords=s||[]}else if(1===this.currentTab&&this.isStudent&&this.isMonitor||0===this.currentTab&&!this.isStudent){this.loadClassAttendance();const a=await Y(null,null,e,t,this.user.classId);this.leaveRecords=a||[]}this.myAttendanceList.length?await this.updateAttendanceStatus():await this.initMyAttendanceList()}catch(t){m({title:"åŠ è½½æ•°æ®å¤±è´¥",icon:"none"})}finally{this.loading=!1}}},getWeekStartDate(e=0){const t=new Date,a=t.getDay(),s=new Date(t);s.setDate(t.getDate()-a);const n=new Date(s);return n.setDate(s.getDate()+7*e),n.setHours(0,0,0,0),n},async initClassStudents(){if(this.isMonitor)try{this.classStudents=await async function(e){try{const t=await o.callFunction({name:"attendance",data:{action:"getClassStudents",classId:e}});if(t.result&&200===t.result.code&&t.result.data){if(Array.isArray(t.result.data)&&t.result.data.length>0&&t.result.data[0].name)return t.result.data;const e=Array.isArray(t.result.data)?t.result.data[0]:t.result.data;if(e&&Array.isArray(e.students))return e.students}return[{_id:"1",name:"å¼ ä¸‰",phone:"13800000001",attendanceStatus:"not-checked"},{_id:"2",name:"æå››",phone:"13800000002",attendanceStatus:"not-checked"},{_id:"3",name:"ç‹äº”",phone:"13800000003",attendanceStatus:"not-checked"},{_id:"4",name:"èµµå…­",phone:"13800000004",attendanceStatus:"not-checked"},{_id:"5",name:"é’±ä¸ƒ",phone:"13800000005",attendanceStatus:"not-checked"}]}catch(t){return[{_id:"1",name:"å¼ ä¸‰",phone:"13800000001",attendanceStatus:"not-checked"},{_id:"2",name:"æå››",phone:"13800000002",attendanceStatus:"not-checked"},{_id:"3",name:"ç‹äº”",phone:"13800000003",attendanceStatus:"not-checked"},{_id:"4",name:"èµµå…­",phone:"13800000004",attendanceStatus:"not-checked"},{_id:"5",name:"é’±ä¸ƒ",phone:"13800000005",attendanceStatus:"not-checked"}]}}(this.user.classId)}catch(e){console.error("åŠ è½½ç­çº§å­¦ç”Ÿå¤±è´¥:",e)}},async loadClassAttendance(e=this.selectedDate,t=this.selectedClass){if(this.isMonitor){this.loading=!0,this.error=!1;try{const a=B(new Date(e)),s=this.rawClassSchedule.find((e=>e.day===a)),n=s&&Array.isArray(s.courses)?s.courses:[];this.classSchedule=[{start:null,end:null,label:"å…¨éƒ¨è¯¾æ—¶"},...n.map((e=>({...e,label:`${e.label}ï¼ˆ${e.type||"æœªçŸ¥"}ï¼‰`})))],Array.isArray(this.classStudents)&&0!==this.classStudents.length||await this.initClassStudents();const{startDate:l,endDate:i}=this.getWeekDateRange(this.currentWeekOffset);if(!l||!i)return console.error("æ— æ³•è·å–å‘¨æ—¥æœŸèŒƒå›´"),void(this.loading=!1);const r=await async function(e,t,a,s,n,l){try{const i={action:"getClassAttendance",classId:e};n&&l?(i.startDate=n,i.endDate=l):t&&(i.date=t),a&&(i.startTime=a),s&&(i.endTime=s);const r=await o.callFunction({name:"attendance",data:i});if(r.result&&200===r.result.code&&r.result.data){const e=r.result.data.filter((e=>null!==e.distance)).map((e=>e.distance));return e.length>0&&(e.reduce(((e,t)=>e+t),0),e.length,Math.max(...e),Math.min(...e)),r.result.data.reduce(((e,t)=>(e[t.status]=(e[t.status]||0)+1,e)),{}),r.result.data}return V(t,a,s)}catch(i){return V(t,a,s)}}(this.user.classId,e,t&&"å…¨éƒ¨è¯¾æ—¶"!==t.label?t.start:null,t&&"å…¨éƒ¨è¯¾æ—¶"!==t.label?t.end:null,l,i)||[];this.processClassAttendance(r),this.calculateStats(),this.filterClassAttendance()}catch(a){console.error("åŠ è½½ç­çº§æ‰“å¡è®°å½•å¤±è´¥:",a),this.error=!0}finally{this.loading=!1}}},processClassAttendance(e){if(!Array.isArray(e))return console.error("è€ƒå‹¤æ•°æ®æ— æ•ˆ"),void(this.classAttendanceList=[]);if(!Array.isArray(this.classStudents))return console.error("å­¦ç”Ÿåˆ—è¡¨æ— æ•ˆ"),void(this.classAttendanceList=[]);const t=this.classStudents.map((e=>e?{...e,attendanceStatus:"not-checked",reason:"",records:[]}:null)).filter((e=>null!==e)),a=new Map;t.forEach(((e,t)=>{e&&e._id&&a.set(e._id,t)})),e.forEach((e=>{if(!e)return;let s=-1;if(e.userId&&a.has(e.userId)?s=a.get(e.userId):e.name&&a.has(e.name)&&(s=a.get(e.name)),-1!==s&&s<t.length){const a=t[s];if(!a)return;"leave"===e.status?(a.attendanceStatus="leave",a.reason=e.reason||"æ— ç†ç”±"):"attended"===e.status&&(a.attendanceStatus="attended",a.attendanceTime=e.time),a.records.push(e)}})),this.classAttendanceList=t},calculateStats(){try{this.stats=q(this.classAttendanceList)}catch(e){console.error("è®¡ç®—ç»Ÿè®¡æ•°æ®å¤±è´¥:",e),this.stats={total:0,attended:0,notChecked:0,leave:0}}},filterClassAttendance(){"all"===this.currentFilter?this.filteredClassAttendanceList=this.classAttendanceList:this.filteredClassAttendanceList=this.classAttendanceList.filter((e=>e.attendanceStatus===this.currentFilter))},async updateAttendanceStatus(){try{this.loading=!0;const{startDate:t,endDate:a}=this.getWeekDateRange(this.currentWeekOffset);if(!t||!a)return;const s=this.attendanceList||[],n=this.leaveRecords||[];let l=[];const i=t;if(!Array.isArray(this.myAttendanceList)||0===this.myAttendanceList.length)return void(this.myAttendanceList=[]);const r=this.myAttendanceList.map((e=>e?{...e,weekDate:i}:null)).filter((e=>null!==e));if(0===r.length)return void(this.myAttendanceList=[]);if(0===this.currentWeekOffset)try{l=ee(r,s,n,this.periodMap,this.user._id)}catch(e){l=r}else this.currentWeekOffset>0?l=r.map((e=>({...e,isFuture:!0,isPast:!1}))):(l=r.map(((t,a)=>{const l=s.find((e=>e.day===t.day&&e.startTime===t.start&&e.endTime===t.end));let i=null;try{i=Q(t,n,this.periodMap,this.user._id)}catch(e){}const r={...t};if(l){r.status="attended",r.attendanceTime=l.time,r.isLate=!1;try{0}catch(e){}}else i?(r.status="leave",r.leaveReason=i.reason,r.leaveStatus=i.status):r.isPast=!0;return r.index=a,r})),l.length);this.myAttendanceList=l||[],this.updateStats()}catch(e){m({title:"æ›´æ–°è¯¾ç¨‹çŠ¶æ€å¤±è´¥",icon:"none"})}finally{this.loading=!1}},getWeekDateRange(e=0){try{const t=new Date,a=new Date(t);a.setDate(t.getDate()+7*e);const s=a.getDay(),n=new Date(a);n.setDate(a.getDate()-s),n.setHours(0,0,0,0);const l=new Date(n);l.setDate(n.getDate()+6),l.setHours(23,59,59,999);const i=U(n);return{startDate:i,endDate:U(l)}}catch(t){console.error("getWeekDateRangeé”™è¯¯:",t);const e=U(new Date);return{startDate:e,endDate:e}}},async handleCheckIn(e){if(!this.isSubmitting)if("attended"!==e.status){this.isSubmitting=!0;try{const t=await this.getLocation();if(!t)return void(this.isSubmitting=!1);const a={userId:this.user._id,name:this.user.name,time:(new Date).toISOString(),location:t,classId:this.user.classId,startTime:e.start,endTime:e.end,day:e.day,courseName:e.label||"æœªçŸ¥è¯¾ç¨‹"};console.log("æäº¤æ‰“å¡å‚æ•°:",a);const s=await z(a);200===s.code?(m({title:"æ‰“å¡æˆåŠŸ",icon:"success"}),this.attendanceList.push(s.data),await this.updateAttendanceStatus()):m({title:s.msg||"æ‰“å¡å¤±è´¥",icon:"none"})}catch(t){console.error("æ‰“å¡å¤±è´¥:",t),m({title:"æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{this.isSubmitting=!1}}else m({title:"æ‚¨å·²ç»æ‰“å¡ï¼Œè¯·å‹¿é‡å¤æ‰“å¡",icon:"none"})},getLocation:()=>new Promise(((e,t)=>{w({type:"gcj02",success:t=>{const a={latitude:t.latitude,longitude:t.longitude,address:`çº¬åº¦: ${t.latitude}, ç»åº¦: ${t.longitude}`};console.log("è·å–ä½ç½®æˆåŠŸ:",a),e(a)},fail:t=>{console.error("è·å–ä½ç½®å¤±è´¥:",t);let a="è·å–ä½ç½®å¤±è´¥";t.errMsg&&(t.errMsg.includes("permission")?a="è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æˆäºˆä½ç½®æƒé™":t.errMsg.includes("timeout")&&(a="è·å–ä½ç½®è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ")),k({title:"ä½ç½®è·å–å¤±è´¥",content:`${a}ã€‚è¯·ç¡®ä¿å·²å¼€å¯ä½ç½®æƒé™ï¼Œå¹¶å…è®¸æµè§ˆå™¨è®¿é—®æ‚¨çš„ä½ç½®ã€‚`,confirmText:"å»è®¾ç½®",cancelText:"å–æ¶ˆ",success:e=>{e.confirm&&uni.openSetting&&uni.openSetting()}}),e({latitude:0,longitude:0,address:"ä½ç½®æœªçŸ¥ (è¯·æ£€æŸ¥ä½ç½®æƒé™)"})}})})),async exportAttendance(){var e,t;try{const a={date:this.selectedDate,startTime:null==(e=this.selectedClass)?void 0:e.start,endTime:null==(t=this.selectedClass)?void 0:t.end,className:this.user.className||"ç­çº§",classId:this.user.classId,userId:this.user._id},s=await async function(e){try{const t={action:"getClassAttendance",date:e.date,startTime:e.startTime,endTime:e.endTime};let a;return e.userId?(t.userId=e.userId,delete t.classId):e.classId&&(t.classId=e.classId,delete t.userId),e.userId,a=await o.callFunction({name:"attendance",data:t}),a.result&&200===a.result.code&&a.result.data?(await o.callFunction({name:"attendance",data:{action:"exportAttendance",data:{title:`${e.className||"ç­çº§"}_è€ƒå‹¤æ•°æ®_${e.date||(new Date).toISOString().split("T")[0]}`,data:a.result.data.map((e=>[e.name||"æœªçŸ¥",e.userId||"",e.status||"æœªçŸ¥",e.reason||"",e.time||"",e.location||""]))}}})).result:{code:400,msg:"æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®"}}catch(t){throw t}}(a);200===s.code&&s.fileID?(p({data:s.fileID,success:()=>{m({title:"ä¸‹è½½é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",icon:"none"})}}),setTimeout((()=>{k({title:"å¯¼å‡ºæˆåŠŸ",content:"æ˜¯å¦ç«‹å³ä¸‹è½½è€ƒå‹¤æ•°æ®ï¼Ÿ",confirmText:"ç«‹å³ä¸‹è½½",cancelText:"ç¨åä¸‹è½½",success:e=>{e.confirm&&window.open(s.fileID)}})}),500)):m({title:s.msg||"å¯¼å‡ºå¤±è´¥",icon:"none"})}catch(a){console.error("å¯¼å‡ºè€ƒå‹¤æ•°æ®å¤±è´¥:",a),m({title:"å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},handleShare(){try{const e={className:this.user.className||"æœªçŸ¥ç­çº§",date:this.selectedDate,stats:this.stats,attendanceList:this.classAttendanceList.map((e=>({name:e.name,status:e.attendanceStatus,reason:e.reason,time:e.attendanceTime})))},t=encodeURIComponent(JSON.stringify(e));x({url:`/pages/attendance/share?data=${t}`})}catch(e){console.error("ç”Ÿæˆåˆ†äº«æ•°æ®å¤±è´¥:",e),m({title:"ç”Ÿæˆæ•°æ®å¤±è´¥",icon:"none"})}},clearCacheData(){this.myAttendanceList=[],this.attendanceList=[],this.leaveRecords=[],this.stats={total:0,attended:0,notChecked:0,leave:0},this.attendanceKey=Date.now()},async handleWeekChange(e){if(e===this.currentWeekOffset)return;this.currentWeekOffset=e;const t=this.getWeekDateRange(this.currentWeekOffset);this.myAttendanceList=[],this.leaveRecords=[];try{this.loading=!0,await this.fetchAttendanceData(t.startDate,t.endDate),this.$nextTick((()=>{this.$refs.studentAttendance&&this.$refs.studentAttendance.forceUpdate()}))}catch(a){m({title:"è·å–æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{this.loading=!1}},async fetchAttendanceData(e,t){try{console.log("fetchAttendanceData - è·å–è€ƒå‹¤æ•°æ®:",e,"è‡³",t);const a=H();this.myAttendanceList&&0!==this.myAttendanceList.length||(this.myAttendanceList=[],await this.initMyAttendanceList());const s=await async function(e,t,a,s){try{const n=H();let l;l="student"===n.role?n._id:e;const i={action:"getStudentAttendance",userId:l};if(delete i.classId,a&&s)i.startDate=a,i.endDate=s;else if(t){const e=new Date(t),a=new Date(t);a.setDate(a.getDate()+6);const s=U(e),n=U(a);i.startDate=s,i.endDate=n}const r=await o.callFunction({name:"attendance",data:i});return r.result&&200===r.result.code&&r.result.data?r.result.data:j(e)}catch(n){return j(e)}}(a._id,null,e,t),n=await Y(a._id,null,e,t);return this.myAttendanceList=ee(this.myAttendanceList,s,n,this.periodMap,a._id),this.leaveRecords=n,this.attendanceRecords=s,{attendanceRecords:s,leaveRecords:n}}catch(a){throw a}},updateStats(){try{if(!Array.isArray(this.myAttendanceList))return void(this.stats={total:0,attended:0,notChecked:0,leave:0});const e=this.myAttendanceList.length,t=this.myAttendanceList.filter((e=>e&&"attended"===e.status)).length,a=this.myAttendanceList.filter((e=>e&&"leave"===e.status)).length,s=this.myAttendanceList.filter((e=>e&&"not-checked"===e.status)).length;this.stats={total:e,attended:t,notChecked:s,leave:a}}catch(e){console.error("æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:",e),this.stats={total:0,attended:0,notChecked:0,leave:0}}},calculateWeekInfo(){const e=new Date,t=e.getDay();e.setDate(e.getDate()-t+7*this.currentWeekOffset);const a=new Date(e);a.setDate(e.getDate()+6);const s=e=>`${e.getMonth()+1}æœˆ${e.getDate()}æ—¥`;this.weekDateRange=`${s(e)} - ${s(a)}`},getWeekStartDateFromDate(e){const t=e instanceof Date?e:new Date(e),a=t.getDay(),s=new Date(t);return s.setDate(t.getDate()-a),s.setHours(0,0,0,0),U(s)},getSelectedClassIndex(){if(!this.selectedClass)return 0;const e=this.classSchedule.findIndex((e=>e.start===this.selectedClass.start&&e.end===this.selectedClass.end));return e>=0?e:0}},watch:{currentWeekOffset:{handler:async function(e,t){this.getWeekDateRange(e),await this.initMyAttendanceList(),this.calculateWeekInfo(),this.attendanceKey=Date.now()},immediate:!0}}},[["render",function(e,o,u,h,f,m){const y=d,g=c,p=D(b("uni-icons"),_),k=F("student-attendance"),C=D(b("uni-datetime-picker"),E),S=M,w=F("attendance-stats"),L=F("class-attendance"),W=D(b("uni-load-more"),R),O=$;return t(),a(y,{class:"attendance-container"},{default:s((()=>[n(y,{class:"tabs"},{default:s((()=>[(t(!0),I(T,null,A(f.tabItems,((e,n)=>(t(),a(y,{key:n,class:l(["tab-item",{active:f.currentTab===n}]),onClick:e=>m.handleTabChange({currentIndex:n})},{default:s((()=>[i(r(e),1)])),_:2},1032,["class","onClick"])))),128))])),_:1}),0===f.currentTab&&m.isStudent?(t(),a(y,{key:0},{default:s((()=>[n(y,{class:"filter-container"},{default:s((()=>[n(y,{class:"date-filter"},{default:s((()=>[n(y,{class:"week-selector"},{default:s((()=>[n(y,{class:"current-week-info"},{default:s((()=>[n(g,{class:"week-text"},{default:s((()=>[i(r(0===f.currentWeekOffset?"æœ¬å‘¨":f.currentWeekOffset>0?`æœªæ¥${f.currentWeekOffset}å‘¨`:`è¿‡å»${Math.abs(f.currentWeekOffset)}å‘¨`),1)])),_:1}),m.calculateCurrentWeek()>0?(t(),a(g,{key:0,class:"week-number"},{default:s((()=>[i("ç¬¬"+r(Math.max(1,m.calculateCurrentWeek()+f.currentWeekOffset))+"å‘¨",1)])),_:1})):v("",!0)])),_:1}),n(y,{class:"week-actions"},{default:s((()=>[n(y,{class:"week-action",onClick:o[0]||(o[0]=e=>m.handleWeekChange(f.currentWeekOffset-1))},{default:s((()=>[n(p,{type:"left",size:"14",color:"#666"}),n(g,null,{default:s((()=>[i("ä¸Šä¸€å‘¨")])),_:1})])),_:1}),n(y,{class:"week-action current",onClick:o[1]||(o[1]=e=>m.handleWeekChange(0))},{default:s((()=>[n(g,null,{default:s((()=>[i("æœ¬å‘¨")])),_:1})])),_:1}),n(y,{class:"week-action",onClick:o[2]||(o[2]=e=>m.handleWeekChange(f.currentWeekOffset+1))},{default:s((()=>[n(g,null,{default:s((()=>[i("ä¸‹ä¸€å‘¨")])),_:1}),n(p,{type:"right",size:"14",color:"#666"})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),f.showStudentAttendance?(t(),a(k,{key:f.attendanceKey,"my-attendance-list":f.myAttendanceList,"is-submitting":f.isSubmitting,"week-schedule":f.rawClassSchedule,"hide-week-navigation":!0,"current-week-offset":f.currentWeekOffset,"current-week-number":f.currentWeekNumber,"local-week-number":f.localWeekNumber,onCheckIn:m.handleCheckIn,onDataUpdated:m.loadData,onWeekChange:m.handleWeekChange},null,8,["my-attendance-list","is-submitting","week-schedule","current-week-offset","current-week-number","local-week-number","onCheckIn","onDataUpdated","onWeekChange"])):v("",!0)])),_:1})):v("",!0),f.currentTab===(m.isStudent?1:0)&&m.isMonitor?(t(),a(y,{key:1},{default:s((()=>[n(y,{class:"filter-container"},{default:s((()=>[n(y,{class:"date-filter"},{default:s((()=>[n(y,{class:"date-picker-wrapper"},{default:s((()=>[n(C,{type:"date",value:f.selectedDate,onChange:m.handleDateChange,border:!1,"clear-icon":!1},null,8,["value","onChange"]),n(y,{class:"clear-date",onClick:m.resetDate},{default:s((()=>[n(p,{type:"reload",size:"14",color:"#999"})])),_:1},8,["onClick"])])),_:1})])),_:1}),n(y,{class:"class-filter"},{default:s((()=>[n(S,{value:m.getSelectedClassIndex(),range:f.classSchedule,"range-key":"label",onChange:m.handleClassChange},{default:s((()=>[n(y,{class:"picker-content"},{default:s((()=>[n(g,{class:"picker-label"},{default:s((()=>[i(r(f.selectedClass?f.selectedClass.label:"å…¨éƒ¨è¯¾æ—¶"),1)])),_:1}),n(p,{type:"bottom",size:"14",color:"#666"})])),_:1})])),_:1},8,["value","range","onChange"])])),_:1})])),_:1}),n(w,{stats:f.stats,"current-filter":f.currentFilter,onFilterChange:m.handleFilterChange},null,8,["stats","current-filter","onFilterChange"]),n(L,{"class-attendance-list":f.filteredClassAttendanceList,"current-filter":f.currentFilter,"selected-date":f.selectedDate,"selected-time-slot":f.selectedClass||{},"is-loading":f.loading,onExport:m.exportAttendance,onShare:m.handleShare},null,8,["class-attendance-list","current-filter","selected-date","selected-time-slot","is-loading","onExport","onShare"])])),_:1})):v("",!0),f.loading?(t(),a(y,{key:2,class:"loading-container"},{default:s((()=>[n(W,{status:"loading","content-text":{contentdown:"åŠ è½½ä¸­..."}},null,8,["content-text"])])),_:1})):v("",!0),f.error?(t(),a(y,{key:3,class:"error-container"},{default:s((()=>[n(y,{class:"error-message"},{default:s((()=>[i("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥")])),_:1}),n(O,{onClick:o[3]||(o[3]=e=>m.loadData(!0)),class:"retry-button"},{default:s((()=>[i("é‡è¯•")])),_:1})])),_:1})):v("",!0)])),_:1})}],["__scopeId","data-v-1cbd1a2a"]]);export{ne as default};
