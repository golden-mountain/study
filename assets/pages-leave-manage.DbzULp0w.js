import{_ as e,q as t,u as a,t as s,f as l,g as n,h as i,j as o,k as r,c as u,w as d,i as c,l as p,U as f,o as _,a as h,m,z as g,d as v,x as y,y as k,F as L,p as C,v as w,n as D,b as S}from"./index-h3lAx3Le.js";import{_ as T}from"./uni-datetime-picker.Ds9IffYk.js";import{_ as b,a as j,b as x,c as A}from"./uni-table.ahOCxD67.js";import{_ as I,a as M}from"./uni-list.GCojYPXx.js";import{_ as z}from"./uni-section.CjICiUR3.js";import{U as $}from"./UserInfo.DLZ9WXF6.js";import{a as E}from"./auth.CK2ut5yY.js";const U=e({components:{UserInfo:$},data:()=>({user:{},leaveList:[],loading:!1,noMoreData:!1,page:1,pageSize:20,filterDate:"",stats:null,isStatsExpanded:!0}),onLoad(){const e=E();e&&(this.user=e,this.loadLeaveList())},methods:{async loadLeaveList(){this.loading=!0;try{let e={classId:this.user.classId};this.filterDate&&(e["time.date"]=this.filterDate);const s=await t.callFunction({name:"leave",data:{action:"list",role:this.user.role,classId:this.user.classId,where:e,page:this.page,pageSize:this.pageSize}});200===s.result.code?(1===this.page?this.leaveList=s.result.data:this.leaveList=this.leaveList.concat(s.result.data),this.noMoreData=s.result.data.length<this.pageSize,this.stats=s.result.stats):a({title:s.result.msg||"获取请假记录失败",icon:"none"})}catch(e){console.error("加载请假记录失败:",e),a({title:"加载请假记录失败",icon:"none"})}this.loading=!1},async approveLeave(e,n){try{const i=await t.callFunction({name:"leave",data:{action:"approve",id:e,status:n,approver:this.user.name,user:this.user}});200===i.result.code?(a({title:"操作成功"}),this.loadLeaveList()):401===i.result.code?(s("user"),s("token"),l({url:"/pages/auth/login"}),a({title:"登录已过期，请重新登录",icon:"none"})):a({title:i.result.msg||"操作失败",icon:"none"})}catch(i){console.error("操作失败:",i),a({title:"操作失败",icon:"none"})}},async cancelApproval(e){try{const s=await t.callFunction({name:"leave",data:{action:"cancelApproval",id:e,approver:this.user.name}});200===s.result.code?(a({title:"取消批准成功"}),this.loadLeaveList()):a({title:s.result.msg||"取消批准失败",icon:"none"})}catch(s){console.error("取消批准失败:",s),a({title:"取消批准失败",icon:"none"})}},formatTime(e){if("string"==typeof e)return new Date(e).toLocaleString();if("dateRange"===e.type)return`从 ${e.value[0]} 到 ${e.value[1]}`;if("course"===e.type){const t=Array.isArray(e.courseTime)?e.courseTime:[e.courseTime];return`${e.date} ${this.getCourseTimeText(t)}`}return"未知时间"},getCourseTimeText(e){if(!e)return"未知时间段";const t={1:"第1节课 (08:30-10:00)",2:"第2节课 (10:30-12:00)",3:"第3节课 (14:00-15:20)",4:"第4节课 (15:30-16:50)",evening:"晚自习 (19:00-20:40)"};return Array.isArray(e)?e.map((e=>t[e]||`第${e}节课`)).join(", "):t[e]||`第${e}节课`},formatStatus(e){switch(e){case"pending":return"待批准";case"approved":return"已批准";case"rejected":return"已拒绝";case"cancelled":return"已取消";default:return"未知状态"}},onReachBottom(){this.noMoreData||this.loading||(this.page++,this.loadLeaveList())},handleDateChange(e){this.filterDate=e,this.page=1,this.loadLeaveList()},navigateToAgree(e){n({url:`/pages/leave/agree?id=${e}`})},loadMore(){this.noMoreData||this.loading||(this.page++,this.loadLeaveList())},goToReport(){n({url:"/pages/leave/report"})}}},[["render",function(e,t,a,s,l,n){const $=C,E=c,U=w,F=i("UserInfo"),R=o(r("uni-datetime-picker"),T),V=o(r("uni-icons"),p),q=o(r("uni-th"),b),B=o(r("uni-tr"),j),N=o(r("uni-td"),x),G=o(r("uni-table"),A),H=o(r("uni-transition"),f),J=o(r("uni-list-item"),I),K=o(r("uni-list"),M),O=o(r("uni-section"),z);return _(),u(E,{class:"container"},{default:d((()=>[h(E,{class:"navbar"},{default:d((()=>[h(E,{class:"left"},{default:d((()=>[h($,{class:"title"},{default:d((()=>[m("请假管理")])),_:1})])),_:1}),h(E,{class:"right"},{default:d((()=>[h(U,{type:"primary",size:"mini",class:"report-btn",onClick:n.goToReport},{default:d((()=>[m("报表导出")])),_:1},8,["onClick"]),h(F,{user:l.user},null,8,["user"])])),_:1})])),_:1}),h(E,{class:"filter"},{default:d((()=>[h(R,{type:"date",modelValue:l.filterDate,"onUpdate:modelValue":t[0]||(t[0]=e=>l.filterDate=e),onChange:n.handleDateChange},null,8,["modelValue","onChange"]),l.stats?(_(),u(E,{key:0,class:"stats"},{default:d((()=>[h(E,{class:"stats-header"},{default:d((()=>[h($,null,{default:d((()=>[m("请假记录汇总：")])),_:1}),h(V,{type:l.isStatsExpanded?"arrowup":"arrowdown",size:"16",onClick:t[1]||(t[1]=e=>l.isStatsExpanded=!l.isStatsExpanded)},null,8,["type"])])),_:1}),h(H,{show:l.isStatsExpanded,mode:"slide-down",duration:300},{default:d((()=>[l.isStatsExpanded?(_(),u(E,{key:0},{default:d((()=>[h(G,null,{default:d((()=>[h(B,null,{default:d((()=>[h(q,null,{default:d((()=>[m("课程")])),_:1}),h(q,null,{default:d((()=>[m("请假记录次数")])),_:1})])),_:1}),h(B,null,{default:d((()=>[h(N,null,{default:d((()=>[m("第1节课")])),_:1}),h(N,null,{default:d((()=>[m(g(l.stats.byCourse[1]),1)])),_:1})])),_:1}),h(B,null,{default:d((()=>[h(N,null,{default:d((()=>[m("第2节课")])),_:1}),h(N,null,{default:d((()=>[m(g(l.stats.byCourse[2]),1)])),_:1})])),_:1}),h(B,null,{default:d((()=>[h(N,null,{default:d((()=>[m("第3节课")])),_:1}),h(N,null,{default:d((()=>[m(g(l.stats.byCourse[3]),1)])),_:1})])),_:1}),h(B,null,{default:d((()=>[h(N,null,{default:d((()=>[m("第4节课")])),_:1}),h(N,null,{default:d((()=>[m(g(l.stats.byCourse[4]),1)])),_:1})])),_:1}),h(B,null,{default:d((()=>[h(N,null,{default:d((()=>[m("晚自习")])),_:1}),h(N,null,{default:d((()=>[m(g(l.stats.byCourse.evening),1)])),_:1})])),_:1})])),_:1})])),_:1})):v("",!0)])),_:1},8,["show"])])),_:1})):v("",!0)])),_:1}),h(O,{title:"全班请假记录",type:"line"},{default:d((()=>[h(K,null,{default:d((()=>[(_(!0),y(L,null,k(l.leaveList,(e=>(_(),u(J,{key:e._id,class:D({"approved-item":"approved"===e.status,"pending-item":"pending"===e.status}),style:S({backgroundColor:"approved"===e.status?"#e8f5e9":"pending"===e.status?"#fff3e0":"inherit"})},{body:d((()=>[h(E,{class:"list-item-content"},{default:d((()=>[h(E,{class:"time-row",onClick:t=>n.navigateToAgree(e._id)},{default:d((()=>[h($,null,{default:d((()=>[m("【"+g(e.userName)+"】"+g(n.formatTime(e.time)),1)])),_:2},1024)])),_:2},1032,["onClick"]),h(E,{class:"reason-row"},{default:d((()=>[h($,null,{default:d((()=>[m(g(e.reason),1)])),_:2},1024)])),_:2},1024),h(E,{class:"status-row"},{default:d((()=>[h($,null,{default:d((()=>[m("状态："+g(n.formatStatus(e.status)),1)])),_:2},1024),h($,null,{default:d((()=>[m("创建时间："+g(new Date(e.createTime).toLocaleString()),1)])),_:2},1024),e.approvedAt?(_(),u($,{key:0},{default:d((()=>[m("批准时间："+g(new Date(e.approvedAt).toLocaleString()),1)])),_:2},1024)):v("",!0),e.approver?(_(),u($,{key:1},{default:d((()=>[m("批准人："+g(e.approver),1)])),_:2},1024)):v("",!0)])),_:2},1024)])),_:2},1024)])),footer:d((()=>[h(E,{class:"actions"},{default:d((()=>["pending"===e.status?(_(),u($,{key:0,class:"action-link",onClick:t=>n.approveLeave(e._id,"approved")},{default:d((()=>[m(" 批准 ")])),_:2},1032,["onClick"])):v("",!0),"pending"===e.status?(_(),u($,{key:1,class:"action-link",onClick:t=>n.approveLeave(e._id,"rejected")},{default:d((()=>[m(" 拒绝 ")])),_:2},1032,["onClick"])):v("",!0),"approved"===e.status||"rejected"===e.status?(_(),u($,{key:2,class:"action-link",onClick:t=>n.cancelApproval(e._id)},{default:d((()=>[m(" 取消批准 ")])),_:2},1032,["onClick"])):v("",!0)])),_:2},1024)])),_:2},1032,["class","style"])))),128))])),_:1}),l.loading?(_(),u(E,{key:0,class:"loading"},{default:d((()=>[m("加载中...")])),_:1})):v("",!0),l.noMoreData||l.loading?v("",!0):(_(),u(E,{key:1,class:"load-more",onClick:n.loadMore},{default:d((()=>[h($,null,{default:d((()=>[m("加载更多")])),_:1})])),_:1},8,["onClick"])),l.noMoreData?(_(),u(E,{key:2,class:"no-more"},{default:d((()=>[m("没有更多数据了")])),_:1})):v("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-9c906e75"]]);export{U as default};
