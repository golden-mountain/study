import{_ as e,u as a,V as t,q as l,t as s,f as i,h as n,j as o,k as r,c,w as d,i as u,o as v,a as p,m as f,n as m,z as _,d as h,p as g,v as y}from"./index-h3lAx3Le.js";import{_ as k}from"./uni-section.CjICiUR3.js";import{U as b}from"./UserInfo.DLZ9WXF6.js";import{a as j}from"./auth.CK2ut5yY.js";const L=e({components:{UserInfo:b},data:()=>({user:j(),leave:{},id:null}),onLoad(e){if(this.id=e.id,!this.id)return a({title:"无效的请假记录ID",icon:"none"}),void t();this.id&&this.loadLeaveDetail(this.id)},methods:{async loadLeaveDetail(e){try{const t=await l.callFunction({name:"leave",data:{action:"get",id:e||this.id}});200===t.result.code?this.leave=t.result.data:a({title:t.result.msg||"获取请假记录失败",icon:"none"})}catch(t){console.error("加载请假记录失败:",t),a({title:"加载请假记录失败",icon:"none"})}},handleAgree(){var e,t,l,s;(null==(e=this.user.role)?void 0:e.includes("instructor"))||(null==(t=this.user.role)?void 0:t.includes("admin"))||(null==(l=this.user.role)?void 0:l.includes("monitor"))||(null==(s=this.user.role)?void 0:s.includes("discipline"))?this.approveLeave("approved"):a({title:"没有审核权限",icon:"none"})},handleReject(){var e,t,l,s;(null==(e=this.user.role)?void 0:e.includes("instructor"))||(null==(t=this.user.role)?void 0:t.includes("admin"))||(null==(l=this.user.role)?void 0:l.includes("monitor"))||(null==(s=this.user.role)?void 0:s.includes("discipline"))?this.approveLeave("rejected"):a({title:"没有审核权限",icon:"none"})},async approveLeave(e){try{const t=await l.callFunction({name:"leave",data:{action:"approve",id:this.id,status:e,approver:this.user.name,user:this.user}});200===t.result.code?(s("redirect_params"),a({title:"操作成功"}),this.loadLeaveDetail(this.id)):401===t.result.code?(s("user"),s("token"),i({url:"/pages/auth/login"}),a({title:"登录已过期，请重新登录",icon:"none"})):a({title:t.result.msg||"操作失败",icon:"none"})}catch(t){console.error("操作失败:",t),a({title:"操作失败",icon:"none"})}},async cancelApproval(){try{const e=await l.callFunction({name:"leave",data:{action:"cancelApproval",id:this.id}});200===e.result.code?(a({title:"取消审核成功"}),this.loadLeaveDetail(this.id)):a({title:e.result.msg||"取消审核失败",icon:"none"})}catch(e){console.error("取消审核失败:",e),a({title:"取消审核失败",icon:"none"})}},navigateToManage(){t()},formatTime(e){return e?"string"==typeof e?new Date(e).toLocaleString():"dateRange"===e.type?`从 ${e.value[0]} 到 ${e.value[1]}`:"course"===e.type?`${e.date} ${this.getCourseTimeText(e.courseTime)}`:"未知时间":"未知时间"},getCourseTimeText(e){if(!e)return"未知时间段";const a={1:"第1节课 (08:30-10:00)",2:"第2节课 (10:30-12:00)",3:"第3节课 (14:00-15:20)",4:"第4节课 (15:30-16:50)",evening:"晚自习 (19:00-20:40)"};return Array.isArray(e)?e.map((e=>a[e]||`第${e}节课`)).join(", "):a[e]||`第${e}节课`},formatStatus(e){switch(e){case"pending":return"待批准";case"approved":return"已批准";case"rejected":return"已拒绝";case"cancelled":return"已取消";default:return"未知状态"}}}},[["render",function(e,a,t,l,s,i){const b=g,j=u,L=n("UserInfo"),A=o(r("uni-section"),k),T=y;return v(),c(j,{class:"container"},{default:d((()=>[p(j,{class:"navbar"},{default:d((()=>[p(j,{class:"left"},{default:d((()=>[p(b,{class:"title"},{default:d((()=>[f("请假审批")])),_:1})])),_:1}),p(L)])),_:1}),s.leave?(v(),c(j,{key:0},{default:d((()=>[p(A,{title:"请假详情",type:"line"},{default:d((()=>[p(j,{class:m({"approved-item":"approved"===s.leave.status,"pending-item":"pending"===s.leave.status})},{default:d((()=>[p(j,{class:"detail"},{default:d((()=>[p(j,{class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("学生姓名：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(s.leave.userName),1)])),_:1})])),_:1}),p(j,{class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("请假时间：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(i.formatTime(s.leave.time)),1)])),_:1})])),_:1}),p(j,{class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("请假原因：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(s.leave.reason),1)])),_:1})])),_:1}),p(j,{class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("状态：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(i.formatStatus(s.leave.status)),1)])),_:1})])),_:1}),p(j,{class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("创建时间：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(new Date(s.leave.createTime).toLocaleString()),1)])),_:1})])),_:1}),s.leave.approvedAt?(v(),c(j,{key:0,class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("批准时间：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(new Date(s.leave.approvedAt).toLocaleString()),1)])),_:1})])),_:1})):h("",!0),s.leave.approver?(v(),c(j,{key:1,class:"detail-item"},{default:d((()=>[p(b,{class:"label"},{default:d((()=>[f("批准人：")])),_:1}),p(b,{class:"value"},{default:d((()=>[f(_(s.leave.approver),1)])),_:1})])),_:1})):h("",!0)])),_:1})])),_:1},8,["class"])])),_:1}),p(j,{class:"actions"},{default:d((()=>["pending"===s.leave.status?(v(),c(T,{key:0,class:"btn",onClick:i.handleAgree},{default:d((()=>[f(" 同意 ")])),_:1},8,["onClick"])):h("",!0),"pending"===s.leave.status?(v(),c(T,{key:1,class:"btn",onClick:i.handleReject},{default:d((()=>[f(" 拒绝 ")])),_:1},8,["onClick"])):h("",!0),"approved"===s.leave.status||"rejected"===s.leave.status?(v(),c(T,{key:2,class:"btn",onClick:i.cancelApproval},{default:d((()=>[f(" 取消审核 ")])),_:1},8,["onClick"])):h("",!0)])),_:1})])),_:1})):(v(),c(j,{key:1},{default:d((()=>[p(b,null,{default:d((()=>[f("加载中...")])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-65a1d4f4"]]);export{L as default};
