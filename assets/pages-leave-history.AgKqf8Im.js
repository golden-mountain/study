import{_ as e,f as a,q as t,t as s,u as i,g as n,Q as l,j as o,k as r,h as c,c as u,w as d,l as p,i as g,o as f,a as h,m,d as v,x as _,y,F as k,p as L,n as C,b as w,z as D}from"./index-h3lAx3Le.js";import{_ as T}from"./uni-datetime-picker.Ds9IffYk.js";import{_ as A,a as j}from"./uni-list.GCojYPXx.js";import{_ as S}from"./uni-section.CjICiUR3.js";import{U as $}from"./UserInfo.DLZ9WXF6.js";import{a as I}from"./auth.CK2ut5yY.js";const b=e({components:{UserInfo:$},data:()=>({user:I()||{},filterDate:"",historyList:[],loading:!1,noMoreData:!1,page:1,pageSize:50}),onLoad(){const e=I();e?(this.user=e,this.loadLeaveList()):a({url:"/pages/auth/login"})},onShow(){const e=I();e?(this.user=e,this.loadLeaveList()):a({url:"/pages/auth/login"})},methods:{async loadLeaveList(){this.loading=!0;try{let e={};this.filterDate&&(e["time.date"]=this.filterDate);const n=await t.callFunction({name:"leave",data:{action:"list",role:this.user.role,userId:this.user._id,classId:this.user.classId,where:e,page:this.page,pageSize:this.pageSize}});if(200===n.result.code)this.historyList=n.result.data,this.noMoreData=n.result.data.length<this.pageSize;else{if(401===n.result.code)return s("token"),s("user"),a({url:"/pages/auth/login"}),void i({title:"登录已过期，请重新登录",icon:"none"});i({title:n.result.msg||"获取请假记录失败",icon:"none"})}}catch(e){console.error("加载请假记录失败:",e),i({title:"加载请假记录失败",icon:"none"})}this.loading=!1},handleDateChange(e){this.filterDate=e,this.page=1,this.loadLeaveList()},async approveLeave(e,a){try{const s=await t.callFunction({name:"leave",data:{action:"approve",id:e,status:a}});200===s.result.code?(i({title:"操作成功"}),this.loadLeaveList()):i({title:s.result.msg||"操作失败",icon:"none"})}catch(s){console.error("操作失败:",s),i({title:"操作失败",icon:"none"})}},async cancelLeave(e){try{const a=await t.callFunction({name:"leave",data:{action:"cancel",id:e}});200===a.result.code?(i({title:"取消成功"}),this.loadLeaveList()):i({title:a.result.msg||"取消失败",icon:"none"})}catch(a){console.error("取消失败:",a),i({title:"取消失败",icon:"none"})}},navigateToAgree(e){n({url:`/pages/leave/agree?id=${e}`})},navigateToApply(){n({url:"/pages/leave/apply"})},navigateToManage(){const e=this.user.role;(e.includes("monitor")||e.includes("discipline"))&&n({url:"/pages/leave/manage"})},formatTime(e){return"string"==typeof e?new Date(e).toLocaleString():"dateRange"===e.type?`从 ${e.value[0]} 到 ${e.value[1]}`:"course"===e.type?`${e.date} ${this.getCourseTimeText(e.courseTime)}`:"未知时间"},getCourseTimeText(e){if(Array.isArray(e))return e.map((e=>{switch(e){case"1":return"第1节课";case"2":return"第2节课";case"3":return"第3节课";case"4":return"第4节课";case"evening":return"晚自习";default:return"未知时间段"}})).join(", ")},formatStatus(e){switch(e){case"pending":return"待批准";case"approved":return"已批准";case"rejected":return"已拒绝";case"cancelled":return"已取消";default:return"未知状态"}},onReachBottom(){this.noMoreData||this.loading||(this.page++,this.loadLeaveList())},copyApplication(e){const a=`学生${e.userName}发出请假信息，请您查看，地址是：${window.location.origin}/h5/?leave_agree=${e._id}`;l({data:a,success:()=>{i({title:"复制成功，请去微信粘贴给辅导员同意你的申请"})},fail:()=>{i({title:"复制失败",icon:"none"})}})}}},[["render",function(e,a,t,s,i,n){const l=L,$=o(r("uni-icons"),p),I=g,b=c("UserInfo"),x=o(r("uni-datetime-picker"),T),z=o(r("uni-list-item"),A),M=o(r("uni-list"),j),U=o(r("uni-section"),S);return f(),u(I,{class:"container"},{default:d((()=>[h(I,{class:"navbar"},{default:d((()=>[h(I,{class:"left"},{default:d((()=>[i.user.role.includes("monitor")||i.user.role.includes("discipline")?(f(),u(l,{key:0,class:"manage-link",onClick:n.navigateToManage},{default:d((()=>[m(" 管理 ")])),_:1},8,["onClick"])):v("",!0),h($,{type:"plus",size:"24",onClick:n.navigateToApply},null,8,["onClick"]),h(l,{class:"apply-text",onClick:n.navigateToApply},{default:d((()=>[m("请假")])),_:1},8,["onClick"])])),_:1}),h(b,{user:i.user},null,8,["user"])])),_:1}),h(I,{class:"filter"},{default:d((()=>[h(x,{type:"date",modelValue:i.filterDate,"onUpdate:modelValue":a[0]||(a[0]=e=>i.filterDate=e),onChange:n.handleDateChange},null,8,["modelValue","onChange"])])),_:1}),h(U,{title:"请假记录",type:"line"},{default:d((()=>[h(M,null,{default:d((()=>[(f(!0),_(k,null,y(i.historyList,(e=>(f(),u(z,{key:e._id,class:C({"approved-item":"approved"===e.status,"pending-item":"pending"===e.status}),style:w({backgroundColor:"approved"===e.status?"#e8f5e9":"pending"===e.status?"#fff3e0":"inherit"})},{body:d((()=>[h(I,{class:"list-item-content"},{default:d((()=>[h(I,{class:"time-row"},{default:d((()=>[h(l,null,{default:d((()=>[m(D(n.formatTime(e.time)),1)])),_:2},1024)])),_:2},1024),h(I,{class:"reason-row"},{default:d((()=>[h(l,null,{default:d((()=>[m(D(e.reason),1)])),_:2},1024)])),_:2},1024),h(I,{class:"status-row"},{default:d((()=>[h(l,null,{default:d((()=>[m("状态："+D(n.formatStatus(e.status)),1)])),_:2},1024),h(l,null,{default:d((()=>[m("创建时间："+D(new Date(e.createTime).toLocaleString()),1)])),_:2},1024),e.approvedAt?(f(),u(l,{key:0},{default:d((()=>[m("批准时间："+D(new Date(e.approvedAt).toLocaleString()),1)])),_:2},1024)):v("",!0),e.approver?(f(),u(l,{key:1},{default:d((()=>[m("批准人："+D(e.approver),1)])),_:2},1024)):v("",!0)])),_:2},1024)])),_:2},1024)])),footer:d((()=>[h(I,{class:"actions"},{default:d((()=>[i.user.role.includes("instructor")?(f(),u(l,{key:0,class:"action-link",onClick:a=>n.navigateToAgree(e._id)},{default:d((()=>[m(" 查看 ")])),_:2},1032,["onClick"])):v("",!0),i.user.role.includes("instructor")&&"pending"===e.status?(f(),u(l,{key:1,class:"action-link",onClick:a=>n.approveLeave(e._id,"approved")},{default:d((()=>[m(" 同意 ")])),_:2},1032,["onClick"])):v("",!0),i.user.role.includes("instructor")&&"pending"===e.status?(f(),u(l,{key:2,class:"action-link",onClick:a=>n.approveLeave(e._id,"rejected")},{default:d((()=>[m(" 拒绝 ")])),_:2},1032,["onClick"])):v("",!0),i.user.role.includes("student")&&"pending"===e.status?(f(),u(l,{key:3,class:"action-link",onClick:a=>n.cancelLeave(e._id)},{default:d((()=>[m(" 取消 ")])),_:2},1032,["onClick"])):v("",!0),h(l,{class:"action-link",onClick:a=>n.copyApplication(e)},{default:d((()=>[m(" 复制申请 ")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["class","style"])))),128))])),_:1}),i.loading?(f(),u(I,{key:0,class:"loading"},{default:d((()=>[m("加载中...")])),_:1})):v("",!0),i.noMoreData?(f(),u(I,{key:1,class:"no-more"},{default:d((()=>[m("没有更多数据了")])),_:1})):v("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-d8e7b33b"]]);export{b as default};
